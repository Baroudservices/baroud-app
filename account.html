<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#070b12;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.65);
      --shadow:0 16px 60px rgba(0,0,0,.35);
      --blue:#1bc7ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, Arial;
      background:linear-gradient(180deg,#0b1424,#050a14);
      color:#fff; min-height:100vh;
      padding:16px;
    }
    .wrap{max-width:860px;margin:auto}
    .top{
      display:flex; align-items:center; gap:10px; margin-bottom:14px;
    }
    .back{
      padding:10px 14px; border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer; text-decoration:none; color:#fff;
    }
    h2{margin:0;font-size:22px}
    .hero{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      overflow:hidden;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .heroImg{
      width:100%;
      height:200px;
      object-fit:cover;
      display:block;
      background:rgba(255,255,255,.04);
    }
    .heroBody{padding:14px}
    .row{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap;
    }
    .title{font-weight:950; font-size:20px}
    .muted{opacity:.7}
    .pills{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      font-weight:800;
      font-size:12px;
      opacity:.9;
    }
    .section{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:12px;
    }
    .section h3{margin:0 0 10px; font-size:16px}
    .features{display:grid; gap:8px}
    .feature{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
    }
    .fKey{font-weight:900}
    .fValue{opacity:.8}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:700px){ .grid2{grid-template-columns:1fr} }
    label{display:block; font-size:12px; opacity:.7; margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:#fff;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:90px; resize:vertical}
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      color:#fff;
      font-weight:950;
      background:linear-gradient(90deg,#0aa0ff,#2a74ff);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .priceRow{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .price{font-weight:950; color:#38bdf8; font-size:18px}
    .msg{margin-top:10px; opacity:.8; font-size:13px}
    .danger{color:#ef4444}
    .ok{color:#22c55e}
    .small{font-size:12px; opacity:.65}
    .hidden{display:none}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <a href="services.html" class="back">←</a>
      <h2>Account</h2>
    </div>

    <div class="hero">
      <img id="heroImg" class="heroImg" src="assets/products/default.png" alt="product">
      <div class="heroBody">
        <div class="row">
          <div>
            <div id="title" class="title">Loading...</div>
            <div id="cat" class="muted">Category:</div>
          </div>
          <div class="priceRow">
            <div class="small">Price</div>
            <div id="price" class="price">$0.00</div>
          </div>
        </div>
        <div id="pills" class="pills"></div>
      </div>
    </div>

    <div class="section">
      <h3>Features</h3>
      <div id="features" class="features"></div>
    </div>

    <div class="section">
      <h3>Order Details</h3>

      <div class="grid2" style="margin-bottom:10px">
        <div>
          <label>Plan</label>
          <select id="planSelect"></select>
        </div>
        <div>
          <label>Notes (optional)</label>
          <input id="notes" placeholder="Any notes..." />
        </div>
      </div>

      <!-- ✅ Dynamic Fields -->
      <div id="dynamic-fields" class="grid2" style="display:none; margin-top:8px">
        <div id="field-player-id" style="display:none">
          <label id="id-label">PLAYER ID</label>
          <input id="input-player-id" placeholder="Enter player id" />
        </div>

        <div id="field-player-name" style="display:none">
          <label>PLAYER NAME</label>
          <input id="input-player-name" placeholder="Enter player name" />
        </div>

        <div id="field-email" style="display:none">
          <label id="email-label">EMAIL / PHONE</label>
          <input id="input-email" placeholder="Enter email or phone" />
        </div>

        <div id="field-pass" style="display:none">
          <label>PASSWORD</label>
          <input id="input-pass" placeholder="Enter password" />
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="buyBtn" class="btn">Place Order</button>
        <div id="msg" class="msg"></div>
      </div>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
  const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const titleEl = document.getElementById("title");
  const catEl = document.getElementById("cat");
  const heroImgEl = document.getElementById("heroImg");
  const pillsEl = document.getElementById("pills");
  const featsEl = document.getElementById("features");
  const planSelect = document.getElementById("planSelect");
  const priceEl = document.getElementById("price");
  const buyBtn = document.getElementById("buyBtn");
  const msgEl = document.getElementById("msg");

  let currentProduct = null;
  let selectedPlan = null;

  function esc(s){ return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  function getId(){ return new URL(location.href).searchParams.get("id"); }

  async function loadProduct(id){
    const { data: p, error: e1 } = await sb.from("products").select("*").eq("id", id).single();
    if(e1) throw new Error(e1.message);

    const { data: f, error: e2 } = await sb.from("product_features").select("*").eq("product_id", id).order("sort");
    if(e2) console.warn(e2.message);

    return { product: p, features: f || [] };
  }

  async function loadPlans(id){
    const { data, error } = await sb.from("product_plan_prices").select("*").eq("product_id", id).eq("active", true);
    if(error) console.warn(error.message);
    return (data || []).map(r=>({ key: r.plan_key, label: r.plan_label || r.plan_key, price: r.price }));
  }

  function renderProduct(p, features){
    currentProduct = p;
    titleEl.textContent = p.title;
    catEl.textContent = "Category: " + p.category;

    heroImgEl.src = `assets/products/${p.id}.jpg`;
    heroImgEl.onerror = () => heroImgEl.src = "assets/products/default.png";

    pillsEl.innerHTML = `
      <span class="pill">${p.active ? 'Available' : 'Unavailable'}</span>
      <span class="pill">${esc(p.category)}</span>
    `;

    featsEl.innerHTML = (features || [])
      .map(f => `<div class="feature"><div class="fKey">${esc(f.label || f.key)}</div><div class="fValue">${esc(f.value)}</div></div>`)
      .join("");

    const df = document.getElementById("dynamic-fields");
    const fId = document.getElementById("field-player-id");
    const fName = document.getElementById("field-player-name");
    const fEmail = document.getElementById("field-email");
    const fPass = document.getElementById("field-pass");

    df.style.display = "none";
    [fId, fName, fEmail, fPass].forEach(el => el.style.display = "none");

    // ✅ dynamic fields driven by product settings (no guessing by title/category)
    const emailInput = document.getElementById("input-email");
    if(emailInput) emailInput.oninput = null;

    // labels (optional per product)
    const idLabelEl = document.getElementById("id-label");
    const emailLabelEl = document.getElementById("email-label");
    if(idLabelEl) idLabelEl.textContent = p.player_id_label || "PLAYER ID";
    if(emailLabelEl) emailLabelEl.textContent = p.email_label || "EMAIL / PHONE";

    const needId   = !!p.require_player_id;
    const needName = !!p.require_player_name;
    const needMail = !!p.require_email;
    const needPass = !!p.require_password;

    if(needId || needName || needMail || needPass){
      df.style.display = "flex";
      if(needId)   fId.style.display = "block";
      if(needName) fName.style.display = "block";
      if(needMail) fEmail.style.display = "block";
      if(needPass) fPass.style.display = "block";
    }
  }

  function setSelectedPlan(plan){
    selectedPlan = plan;
    priceEl.textContent = "$" + Number(plan.price).toFixed(2);
  }

  function renderPlans(plans){
    planSelect.innerHTML = "";
    if(!plans || plans.length === 0){
      planSelect.innerHTML = `<option value="">No plans</option>`;
      setSelectedPlan({ key:"default", label:"Default", price: Number(currentProduct?.price || 0) });
      return;
    }
    plans.forEach((p, i) => {
      const opt = document.createElement("option");
      opt.value = p.key;
      opt.textContent = `${p.label} - $${Number(p.price).toFixed(2)}`;
      planSelect.appendChild(opt);
      if(i === 0) setSelectedPlan(p);
    });

    planSelect.onchange = () => {
      const k = planSelect.value;
      const plan = plans.find(x => x.key === k);
      if(plan) setSelectedPlan(plan);
    };
  }

  async function placeOrder(){
    msgEl.className = "msg";
    msgEl.textContent = "";

    const { data: { session } } = await sb.auth.getSession();
    if(!session){ location.replace("login.html"); return; }

    if(!currentProduct || !selectedPlan){
      msgEl.className = "msg danger";
      msgEl.textContent = "Missing product/plan";
      return;
    }

    const notes = document.getElementById("notes").value || "";
    const playerId = document.getElementById("input-player-id").value || "";
    const playerName = document.getElementById("input-player-name").value || "";
    const email = document.getElementById("input-email").value || "";
    const pass = document.getElementById("input-pass").value || "";

    // Simple front validation حسب flags
    if(currentProduct.require_player_id && !playerId.trim()){
      msgEl.className = "msg danger"; msgEl.textContent = "Please enter Player ID"; return;
    }
    if(currentProduct.require_player_name && !playerName.trim()){
      msgEl.className = "msg danger"; msgEl.textContent = "Please enter Player Name"; return;
    }
    if(currentProduct.require_email && !email.trim()){
      msgEl.className = "msg danger"; msgEl.textContent = "Please enter Email/Phone"; return;
    }
    if(currentProduct.require_password && !pass.trim()){
      msgEl.className = "msg danger"; msgEl.textContent = "Please enter Password"; return;
    }

    buyBtn.disabled = true;
    buyBtn.textContent = "Placing...";

    // ⚠️ حاليا: نفس منطقك القديم (insert order)
    // لما نركّب نظام wallet (خصم رصيد + paid)، منبدّلها لـ RPC create_order_and_pay.
    const orderPayload = {
      user_id: session.user.id,
      product_id: currentProduct.id,
      price: Number(selectedPlan.price || currentProduct.price || 0),
      status: "pending",
      delivery_status: "pending",
      plan_key: selectedPlan.key,
      notes: notes,
      player_id: playerId,
      player_name: playerName,
      email: email,
      password: pass
    };

    const { error } = await sb.from("orders").insert(orderPayload);

    buyBtn.disabled = false;
    buyBtn.textContent = "Place Order";

    if(error){
      msgEl.className = "msg danger";
      msgEl.textContent = "Error: " + error.message;
      return;
    }

    msgEl.className = "msg ok";
    msgEl.textContent = "Order placed ✅";
    setTimeout(()=> location.href="my-orders.html", 600);
  }

  buyBtn.onclick = placeOrder;

  (async function init(){
    const id = getId();
    if(!id){
      titleEl.textContent = "Missing id";
      return;
    }

    try{
      const { product, features } = await loadProduct(id);
      renderProduct(product, features);

      const plans = await loadPlans(id);
      renderPlans(plans);
    }catch(err){
      titleEl.textContent = "Error";
      msgEl.className = "msg danger";
      msgEl.textContent = String(err.message || err);
    }
  })();
</script>
</body>
</html>
