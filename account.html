<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#070b12;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.65);
      --shadow:0 16px 60px rgba(0,0,0,.35);
      --blue:#1bc7ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, Arial;
      background:linear-gradient(180deg,#0b1424,#050a14);
      color:#fff; min-height:100vh;
      padding:16px;
    }
    .wrap{max-width:860px;margin:auto}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:14px;
    }
    .leftTop{display:flex; align-items:center; gap:10px}
    .back{
      padding:10px 14px; border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer; text-decoration:none; color:#fff;
    }
    h2{margin:0;font-size:22px}

    .smallBtn{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:#fff; font-weight:900;
      cursor:pointer;
    }

    .ordersDD{position:relative;display:inline-block;z-index:99999}
    .ordersMenu{
      position:absolute; right:0; top:44px;
      width:220px;
      background:rgba(10,14,22,.98);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:8px;
      display:none;
      box-shadow:var(--shadow);
      max-height:260px;
      overflow:auto;
    }
    .ordersItem{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
      margin-bottom:8px;
      font-weight:900;
      font-size:13px;
    }
    .ordersItem:hover{background:rgba(255,255,255,.06)}
    .badge{
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      border:1px solid rgba(255,255,255,.10);
      opacity:.9;
    }

    .hero{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      overflow:hidden;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .heroImg{
      width:100%;
      height:200px;
      object-fit:cover;
      display:block;
      background:rgba(255,255,255,.04);
    }
    .heroBody{padding:14px}
    .row{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap;
    }
    .title{font-weight:950; font-size:20px}
    .muted{opacity:.7}
    .pills{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      font-weight:800;
      font-size:12px;
      opacity:.9;
    }
    .section{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:12px;
    }
    .section h3{margin:0 0 10px; font-size:16px}
    .features{display:grid; gap:8px}
    .feature{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
    }
    .fKey{font-weight:900}
    .fValue{opacity:.8}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:700px){ .grid2{grid-template-columns:1fr} }
    label{display:block; font-size:12px; opacity:.7; margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:#fff;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:90px; resize:vertical}
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      color:#fff;
      font-weight:950;
      background:linear-gradient(90deg,#0aa0ff,#2a74ff);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .priceRow{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .price{font-weight:950; color:#38bdf8; font-size:18px}
    .msg{margin-top:10px; opacity:.85; font-size:13px}
    .danger{color:#ef4444}
    .ok{color:#22c55e}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="leftTop">
        <a href="services.html" class="back">←</a>
        <h2>Account</h2>
      </div>

      <div class="ordersDD" id="ordersDD">
        <button class="smallBtn" id="myOrdersBtn">My Orders</button>
        <div class="ordersMenu" id="ordersMenu"></div>
      </div>
    </div>

    <div class="hero">
      <img id="heroImg" class="heroImg" src="assets/products/default.png" alt="product">
      <div class="heroBody">
        <div class="row">
          <div>
            <div id="title" class="title">Loading...</div>
            <div id="cat" class="muted">Category:</div>
          </div>
          <div class="priceRow">
            <div class="muted" style="font-size:12px">Price</div>
            <div id="price" class="price">$0.00</div>
          </div>
        </div>
        <div id="pills" class="pills"></div>
      </div>
    </div>

    <div class="section">
      <h3>Features</h3>
      <div id="features" class="features"></div>
    </div>

    <div class="section">
      <h3>Order Details</h3>

      <div class="grid2" style="margin-bottom:10px">
        <div>
          <label>Plan</label>
          <select id="planSelect"></select>
        </div>
        <div>
          <label>Notes (optional)</label>
          <input id="notes" placeholder="Any notes..." />
        </div>
      </div>

      <div style="margin-bottom:10px">
        <label>Customer Note (optional)</label>
        <textarea id="customerNote" placeholder="Write any extra details..."></textarea>
      </div>

      <!-- ✅ Dynamic Fields -->
      <div id="dynamic-fields" class="grid2" style="display:none; margin-top:8px">
        <div id="field-player-id" style="display:none">
          <label id="id-label">PLAYER ID</label>
          <input id="input-player-id" placeholder="Enter player id" />
        </div>

        <div id="field-zone-id" style="display:none">
          <label id="zone-label">ZONE ID</label>
          <input id="input-zone-id" placeholder="Enter zone id" />
        </div>

        <div id="field-player-name" style="display:none">
          <label id="name-label">PLAYER NAME</label>
          <input id="input-player-name" placeholder="Enter player name" />
        </div>

        <div id="field-email" style="display:none">
          <label id="email-label">EMAIL</label>
          <input id="input-email" placeholder="Enter email" />
        </div>

        <div id="field-phone" style="display:none">
          <label id="phone-label">PHONE NUMBER</label>
          <input id="input-phone" placeholder="Enter phone number" />
        </div>

        <div id="field-whatsapp" style="display:none">
          <label id="whatsapp-label">WHATSAPP NUMBER</label>
          <input id="input-whatsapp" placeholder="Enter WhatsApp number" />
        </div>

        <div id="field-username" style="display:none">
          <label id="username-label">USERNAME</label>
          <input id="input-username" placeholder="Enter username" />
        </div>

        <div id="field-pass" style="display:none">
          <label id="pass-label">PASSWORD</label>
          <input id="input-pass" placeholder="Enter password" />
        </div>

        <div id="field-backup" style="display:none; grid-column:1 / -1">
          <label id="backup-label">BACKUP CODES</label>
          <textarea id="input-backup" placeholder="Enter backup codes..."></textarea>
        </div>

        <div id="field-account-details" style="display:none; grid-column:1 / -1">
          <label id="account-details-label">ACCOUNT DETAILS</label>
          <textarea id="input-account-details" placeholder="Enter account details..."></textarea>
        </div>
      </div>

      <button id="buyBtn" class="btn" style="margin-top:12px">Buy Now</button>
      <div id="msg" class="msg"></div>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
  const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const titleEl = document.getElementById("title");
  const catEl = document.getElementById("cat");
  const heroImgEl = document.getElementById("heroImg");
  const pillsEl = document.getElementById("pills");
  const featsEl = document.getElementById("features");
  const planSelect = document.getElementById("planSelect");
  const priceEl = document.getElementById("price");
  const buyBtn = document.getElementById("buyBtn");
  const msgEl = document.getElementById("msg");
  const customerNoteEl = document.getElementById("customerNote");

  const ordersDD = document.getElementById("ordersDD");
  const myOrdersBtn = document.getElementById("myOrdersBtn");
  const ordersMenu = document.getElementById("ordersMenu");

  let PLAN_LIST = [];
  let currentProductId = null;
  let currentProduct = null;
  let selectedPlan = null;

  function esc(s){ return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  function getId(){ return new URL(location.href).searchParams.get("id"); }

  function setMsg(text, ok=false){
    msgEl.className = "msg " + (ok ? "ok" : "danger");
    msgEl.textContent = text || "";
  }

  function clearAllInputs(){
    const ids = [
      "notes","customerNote",
      "input-player-id","input-zone-id","input-player-name",
      "input-email","input-phone","input-whatsapp","input-username",
      "input-pass","input-backup","input-account-details"
    ];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value = "";
    });
  }

  async function loadProduct(id){
    const { data: p, error: e1 } = await sb.from("products").select("*").eq("id", id).single();
    if(e1) throw e1;

    const { data: f } = await sb.from("product_features").select("*").eq("product_id", id).order("sort");
    return { product: p, features: f || [] };
  }

  async function loadPlans(productId){
    const { data, error } = await sb
      .from("product_plan_prices")
      .select("*")
      .eq("product_id", productId)
      .eq("active", true)
      .order("sort", { ascending: true });

    if(error) return [];
    return (data || []).map(r => ({
      key: r.plan_key,
      label: r.plan_label || r.plan_key,
      price: Number(r.price || 0)
    }));
  }

  function renderFeatures(features){
    featsEl.innerHTML = (features || [])
      .map(f => `<div class="feature"><div class="fKey">${esc(f.label || f.key)}</div><div class="fValue">${esc(f.value)}</div></div>`)
      .join("");
  }

  function applyDynamicFields(){
    const df = document.getElementById("dynamic-fields");

    const fId = document.getElementById("field-player-id");
    const fZone = document.getElementById("field-zone-id");
    const fName = document.getElementById("field-player-name");
    const fEmail = document.getElementById("field-email");
    const fPhone = document.getElementById("field-phone");
    const fWhats = document.getElementById("field-whatsapp");
    const fUser = document.getElementById("field-username");
    const fPass = document.getElementById("field-pass");
    const fBackup = document.getElementById("field-backup");
    const fAcc = document.getElementById("field-account-details");

    // reset
    df.style.display = "none";
    [fId,fZone,fName,fEmail,fPhone,fWhats,fUser,fPass,fBackup,fAcc].forEach(el=>el.style.display="none");

    // labels
    document.getElementById("id-label").textContent = currentProduct.player_id_label || "PLAYER ID";
    document.getElementById("zone-label").textContent = currentProduct.zone_id_label || "ZONE ID";
    document.getElementById("name-label").textContent = currentProduct.player_name_label || "PLAYER NAME";
    document.getElementById("email-label").textContent = currentProduct.email_label || "EMAIL";
    document.getElementById("phone-label").textContent = currentProduct.phone_label || "PHONE NUMBER";
    document.getElementById("whatsapp-label").textContent = currentProduct.whatsapp_label || "WHATSAPP NUMBER";
    document.getElementById("username-label").textContent = currentProduct.username_label || "USERNAME";
    document.getElementById("pass-label").textContent = currentProduct.password_label || "PASSWORD";
    document.getElementById("backup-label").textContent = currentProduct.backup_codes_label || "BACKUP CODES";
    document.getElementById("account-details-label").textContent = currentProduct.account_details_label || "ACCOUNT DETAILS";

    // base flags from DB
    let needId   = !!currentProduct.require_player_id;
    let needZone = !!currentProduct.require_zone_id;
    let needName = !!currentProduct.require_player_name;
    let needEmail= !!currentProduct.require_email;
    let needPass = !!currentProduct.require_password;
    let needUser = !!currentProduct.require_username;
    let needPhone= !!currentProduct.require_phone;
    let needWhats= !!currentProduct.require_whatsapp;
    let needBackup = !!currentProduct.require_backup_codes;
    let needAcc = !!currentProduct.require_account_details;

    // ✅ Plan keyword rules
    const planText = ((selectedPlan?.label || selectedPlan?.key || "") + "").toLowerCase();
    const titleText = (currentProduct.title || "").toLowerCase();

    // Shahid VIP: if direct -> Email + Pass
    if(titleText.includes("shahid") && planText.includes("direct")){
      needEmail = true;
      needPass = true;
    }

    // ChatGPT Plus: if private -> Email only
    if(titleText.includes("chatgpt") && planText.includes("private")){
      needEmail = true;
      needPass = false;
    }

    // TikTok coins: pass + (phone OR email)
    // في DB عندك require_phone=true AND require_email=true AND require_password=true
    // UI: نعرض الاتنين، بس بالتحقق نقبل واحد منهم.
    // ما بدنا تغيير هون، بس منخليهم يبينوا.
    // (التحقق تحت)

    // show if any needed
    if(needId || needZone || needName || needEmail || needPhone || needWhats || needUser || needPass || needBackup || needAcc){
      df.style.display = "grid";
      if(needId) fId.style.display = "block";
      if(needZone) fZone.style.display = "block";
      if(needName) fName.style.display = "block";
      if(needEmail) fEmail.style.display = "block";
      if(needPhone) fPhone.style.display = "block";
      if(needWhats) fWhats.style.display = "block";
      if(needUser) fUser.style.display = "block";
      if(needPass) fPass.style.display = "block";
      if(needBackup) fBackup.style.display = "block";
      if(needAcc) fAcc.style.display = "block";
    }
  }

  function renderProduct(p, features){
    currentProduct = p;
    currentProductId = p.id;

    titleEl.textContent = p.title || "Product";
    catEl.textContent = "Category: " + (p.category || "-");

    heroImgEl.src = `assets/products/${p.id}.jpg`;
    heroImgEl.onerror = () => heroImgEl.src = "assets/products/default.png";

    pillsEl.innerHTML = `
      <span class="pill">${p.active ? "Available" : "Unavailable"}</span>
      <span class="pill">${esc(p.category || "")}</span>
    `;

    renderFeatures(features);
  }

  function renderPlans(plans){
    PLAN_LIST = plans || [];
    planSelect.innerHTML = "";

    if(!PLAN_LIST.length){
      const opt = document.createElement("option");
      opt.value = "none";
      opt.textContent = "No plans";
      planSelect.appendChild(opt);

      selectedPlan = { key:"default", label:"default", price:Number(currentProduct?.price || 0) };
      priceEl.textContent = "$" + Number(selectedPlan.price || 0).toFixed(2);
      applyDynamicFields();
      return;
    }

    PLAN_LIST.forEach((pl, i)=>{
      const opt = document.createElement("option");
      opt.value = pl.key;
      opt.textContent = `${pl.label} - $${Number(pl.price||0).toFixed(2)}`;
      planSelect.appendChild(opt);
      if(i===0) selectedPlan = pl;
    });

    priceEl.textContent = "$" + Number(selectedPlan.price || 0).toFixed(2);
    applyDynamicFields();

    planSelect.onchange = ()=>{
      const k = planSelect.value;
      const plan = PLAN_LIST.find(x=>x.key===k);
      if(plan) selectedPlan = plan;
      priceEl.textContent = "$" + Number(selectedPlan.price || 0).toFixed(2);
      applyDynamicFields();
    };
  }

  async function loadMyOrdersMenu(){
    ordersMenu.innerHTML = `<div style="opacity:.7;padding:10px">Loading...</div>`;
    const { data: { session } } = await sb.auth.getSession();
    if(!session){
      ordersMenu.innerHTML = `<div style="opacity:.7;padding:10px">Login first</div>`;
      return;
    }

    const { data, error } = await sb
      .from("orders")
      .select("id,status,delivery_status,created_at")
      .eq("user_id", session.user.id)
      .order("created_at", {ascending:false})
      .limit(8);

    if(error){
      ordersMenu.innerHTML = `<div style="opacity:.7;padding:10px">Error</div>`;
      return;
    }

    if(!data || !data.length){
      ordersMenu.innerHTML = `<div style="opacity:.7;padding:10px">No orders</div>`;
      return;
    }

    ordersMenu.innerHTML = data.map(o=>{
      const d = (o.delivery_status || "pending").toLowerCase();
      const pay = (o.status || "pending").toLowerCase();
      const show = (d === "rejected") ? "rejected" : pay;
      return `
        <div class="ordersItem" onclick="location.href='my-orders.html'">
          <span>#${o.id}</span>
          <span class="badge">${esc(show)}</span>
        </div>
      `;
    }).join("");
  }

  myOrdersBtn.onclick = async ()=>{
    const open = ordersMenu.style.display === "block";
    ordersMenu.style.display = open ? "none" : "block";
    if(!open) await loadMyOrdersMenu();
  };
  document.addEventListener("click", (e)=>{
    if(!ordersDD.contains(e.target)){
      ordersMenu.style.display = "none";
    }
  });

  function buildExtraNote(extra){
    // نحط الإضافات داخل note حتى ما نغيّر RPC
    const lines = [];
    for(const [k,v] of Object.entries(extra)){
      const val = (v || "").toString().trim();
      if(val) lines.push(`${k}: ${val}`);
    }
    if(!lines.length) return "";
    return "\n\n---\n" + lines.join("\n");
  }

  async function buyProduct(){
    setMsg("");

    if(!selectedPlan){
      setMsg("Select a plan first");
      return;
    }

    // read inputs
    const pId = document.getElementById("input-player-id").value.trim();
    const zId = document.getElementById("input-zone-id").value.trim();
    const pName = document.getElementById("input-player-name").value.trim();
    const pEmail = document.getElementById("input-email").value.trim();
    const pPhone = document.getElementById("input-phone").value.trim();
    const pWhats = document.getElementById("input-whatsapp").value.trim();
    const pUser = document.getElementById("input-username").value.trim();
    const pPass = document.getElementById("input-pass").value.trim();
    const pBackup = document.getElementById("input-backup").value.trim();
    const pAcc = document.getElementById("input-account-details").value.trim();

    // what is visible/required (based on dynamic flags)
    const isVisible = (id)=> document.getElementById(id)?.style.display === "block";

    // ✅ validation per visible fields
    if(isVisible("field-player-id") && !pId){ setMsg("ID is required"); return; }
    if(isVisible("field-zone-id") && !zId){ setMsg("Zone ID is required"); return; }
    if(isVisible("field-player-name") && !pName){ setMsg("Name is required"); return; }
    if(isVisible("field-username") && !pUser){ setMsg("Username is required"); return; }
    if(isVisible("field-whatsapp") && !pWhats){ setMsg("WhatsApp number is required"); return; }
    if(isVisible("field-pass") && !pPass){ setMsg("Password is required"); return; }
    if(isVisible("field-backup") && !pBackup){ setMsg("Backup codes are required"); return; }
    if(isVisible("field-account-details") && !pAcc){ setMsg("Account details are required"); return; }

    // ✅ TikTok rule: phone OR email required (when both fields shown)
    const titleText = (currentProduct.title || "").toLowerCase();
    if(titleText.includes("tiktok")){
      // إذا واحد من الاتنين ظاهر، لازم يدخل واحد على الأقل
      const emailShown = isVisible("field-email");
      const phoneShown = isVisible("field-phone");
      if((emailShown || phoneShown) && (!pEmail && !pPhone)){
        setMsg("Enter Email or Phone number");
        return;
      }
      if(isVisible("field-pass") && !pPass){
        setMsg("Password is required");
        return;
      }
    } else {
      if(isVisible("field-email") && !pEmail){ setMsg("Email is required"); return; }
      if(isVisible("field-phone") && !pPhone){ setMsg("Phone number is required"); return; }
    }

    if(!confirm("Proceed with purchase? Balance will be deducted.")) return;

    buyBtn.disabled = true;
    buyBtn.textContent = "Processing...";

    try{
      const { data: { session } } = await sb.auth.getSession();
      if(!session){ location.href="login.html"; return; }

      const notes = document.getElementById("notes").value || "";
      const baseNote = (customerNoteEl.value || "").trim();
      const extraNote = buildExtraNote({
        "Plan": selectedPlan.label || selectedPlan.key,
        "Notes": notes,
        "ID": pId,
        "Zone ID": zId,
        "Name": pName,
        "Email": pEmail,
        "Phone": pPhone,
        "WhatsApp": pWhats,
        "Username": pUser,
        "Backup Codes": pBackup,
        "Account Details": pAcc
      });

      const finalNote = (baseNote + extraNote).trim();

      // ✅ keep your original RPC signature (no new params)
      const { data: orderId, error } = await sb.rpc("place_order", {
        p_product_id: currentProductId,
        p_price: selectedPlan.price,
        p_duration: selectedPlan.label,
        p_note: finalNote || null,
        p_player_id: pId || null,
        p_player_name: pName || null,
        p_acc_email: (pEmail || pPhone) || null,   // ✅ for tiktok we can store phone or email here
        p_acc_pass: pPass || null
      });

      if(error) throw error;

      // ✅ clear inputs after success (طلبك)
      clearAllInputs();

      // Optional WA message (keep if you want)
      if(titleText.includes("tiktok")){
        const waMsg = `Hello Baroud Services, I just bought TikTok Coins. Order ID: ${orderId}. Contact: ${(pEmail || pPhone)}.`;
        window.open(`https://wa.me/96170385398?text=${encodeURIComponent(waMsg)}`);
      }

      alert("✅ Order Placed Successfully! ID: " + orderId);
      location.href = "my-orders.html";
    }catch(e){
      alert(e.message || "Purchase failed");
    }finally{
      buyBtn.disabled = false;
      buyBtn.textContent = "Buy Now";
    }
  }

  buyBtn.onclick = buyProduct;

  (async function init(){
    const id = getId();
    if(!id){
      titleEl.textContent = "Missing id";
      return;
    }
    try{
      const { product, features } = await loadProduct(id);
      renderProduct(product, features);

      const plans = await loadPlans(product.id);
      renderPlans(plans);
    }catch(err){
      titleEl.textContent = "Error";
      setMsg(err?.message || String(err));
    }
  })();
</script>
</body>
</html>
