<script>
  const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";

  // âœ… Ø­Ø· Ù‡ÙˆÙ† anon public key (eyJ...):
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcndpdG9sb25oZmJmd3RzbmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjQyNTcsImV4cCI6MjA4MzA0MDI1N30.N-OqDDDOz1wJnKfmOFAtwlH00m_oJvUKEQvbygVeujQ";

  // âœ… Ù†ÙØ³ storageKey Ø¨ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª (login/admin/wish)
  const STORAGE_KEY = "baroud_auth_v1";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storageKey: STORAGE_KEY
    }
  });

  const msg = document.getElementById("msg");
  const loginBtn = document.getElementById("loginBtn");
  const registerBtn = document.getElementById("registerBtn");
  const resetBtn = document.getElementById("resetBtn");

  function showMsg(text, ok=false){
    msg.style.display="block";
    msg.className = "msg " + (ok ? "ok" : "err");
    msg.textContent = text;
  }
  function hideMsg(){
    msg.style.display="none";
    msg.textContent="";
  }
  function setLoading(isLoading, text){
    loginBtn.disabled = isLoading;
    registerBtn.disabled = isLoading;
    resetBtn.disabled = isLoading;
    loginBtn.textContent = isLoading ? (text || "Please wait...") : "Login";
  }

  // âœ… Ø¥Ø°Ø§ Ø¹Ø§Ù…Ù„ login already -> Ø±ÙˆØ­ services
  (async ()=>{
    try{
      const { data, error } = await sb.auth.getSession();
      if(error) console.log(error);
      if (data.session?.user) location.replace("services.html?v=" + Date.now());
    }catch(e){}
  })();

  async function doLogin(){
    hideMsg();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("pass").value;

    if(!email || !password){
      showMsg("Fill email and password.");
      return;
    }

    setLoading(true, "Signing in...");

    try{
      const { data, error } = await sb.auth.signInWithPassword({ email, password });

      if (error){
        showMsg(error.message || "Login failed.");
        return;
      }

      const user = data?.user;
      const confirmedAt = user?.email_confirmed_at || user?.confirmed_at;

      if(!confirmedAt){
        await sb.auth.signOut();
        showMsg("Please confirm your email first ðŸ“§ (Check your inbox).");
        return;
      }

      showMsg("Login successful âœ…", true);
      setTimeout(()=> location.replace("services.html?v=" + Date.now()), 250);

    }catch(e){
      showMsg("Network error. Try again.");
    }finally{
      setLoading(false);
    }
  }

  async function doRegister(){
    hideMsg();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("pass").value;

    if(!email || !password){
      showMsg("Fill email and password.");
      return;
    }
    if(password.length < 6){
      showMsg("Password must be at least 6 characters.");
      return;
    }

    setLoading(true, "Creating...");

    try{
      const { error } = await sb.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: "https://baroudservices.github.io/baroud-app/confirmed.html"
        }
      });

      if (error){
        showMsg(error.message || "Register failed.");
        return;
      }

      showMsg("Register successful âœ… Check your email ðŸ“§", true);

    }catch(e){
      showMsg("Network error. Try again.");
    }finally{
      setLoading(false);
    }
  }

  async function doReset(){
    hideMsg();
    const email = document.getElementById("email").value.trim();
    if(!email){
      showMsg("Enter your email first.");
      return;
    }

    setLoading(true, "Sending...");

    try{
      const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: "https://baroudservices.github.io/baroud-app/login.html"
      });

      if(error){
        showMsg(error.message || "Reset failed.");
        return;
      }

      showMsg("Reset email sent âœ… Check your inbox ðŸ“§", true);

    }catch(e){
      showMsg("Network error. Try again.");
    }finally{
      setLoading(false);
    }
  }

  loginBtn.addEventListener("click", doLogin);
  registerBtn.addEventListener("click", doRegister);
  resetBtn.addEventListener("click", doReset);

  document.getElementById("pass").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") doLogin();
  });
</script>
