<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin – Deposit Requests</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:system-ui,Arial;
  background:linear-gradient(160deg,#060b16,#0a1330);
  color:#fff;
  padding:16px;
}
.wrap{max-width:1000px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:10px;flex-wrap:wrap}
.btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;background:#1e293b;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #334155;font-size:14px;vertical-align:top}
th{color:#93c5fd;text-align:left}
.status{font-weight:bold}
.ok{color:#22c55e}
.no{color:#ef4444}
.pending{color:#fbbf24}

.actionBtn{
  padding:8px 10px;
  border-radius:10px;
  border:0;
  cursor:pointer;
  background:#1e293b;
  color:#fff;
  margin-right:6px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  text-decoration:none;
  min-width:38px;
}
.actionBtn:active{transform:scale(.98)}
.actionBtn.okBtn{background:rgba(34,197,94,.15); border:1px solid rgba(34,197,94,.35)}
.actionBtn.noBtn{background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35)}
.actionBtn.viewBtn{background:rgba(59,130,246,.15); border:1px solid rgba(59,130,246,.35)}
.actionBtn:disabled{opacity:.55; cursor:not-allowed; transform:none}

.small{opacity:.75;font-size:12px}
.notice{
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  white-space:pre-wrap;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <h2 style="margin:0;">Admin – Deposit Requests</h2>
    <div style="display:flex; gap:10px;">
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <div id="notice" class="notice" style="display:none;"></div>

  <table>
    <thead>
      <tr>
        <th style="width:70px">ID</th>
        <th>User</th>
        <th>Amount</th>
        <th>Method</th>
        <th>Status</th>
        <th>Receipt</th>
        <th>Transfer #</th>
        <th style="width:120px">Action</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <p id="empty" style="display:none;opacity:.6">No deposits found</p>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";

/* ✅ استخدم publishable key */
const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= DOM ================= */
const rowsEl = document.getElementById("rows");
const emptyEl = document.getElementById("empty");
const btnRefresh = document.getElementById("btnRefresh");
const btnLogout = document.getElementById("btnLogout");
const noticeEl = document.getElementById("notice");

/* ================= HELPERS ================= */
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function showNotice(text){
  if(!text){
    noticeEl.style.display = "none";
    noticeEl.textContent = "";
    return;
  }
  noticeEl.style.display = "block";
  noticeEl.textContent = text;
}

function fmtErr(e){
  const msg = (e?.message ?? String(e ?? "Error"));
  const det = e?.details ? `\nDetails: ${e.details}` : "";
  const hint = e?.hint ? `\nHint: ${e.hint}` : "";
  const code = e?.code ? `\nCode: ${e.code}` : "";
  return msg + det + hint + code;
}

/* deposits.id = bigint */
function normalizeDepositId(raw){
  const s = String(raw ?? "").trim();
  const n = Number(s);
  if(!Number.isFinite(n)) throw new Error("Invalid deposit id");
  return n;
}

function setBusy(isBusy){
  btnRefresh.disabled = isBusy;
  btnLogout.disabled = isBusy;
  rowsEl.querySelectorAll("button.actionBtn").forEach(b => b.disabled = isBusy);
}

/* ================= AUTH / ADMIN ================= */
async function requireSession(){
  const { data: s, error: sErr } = await sb.auth.getSession();
  if(sErr) throw sErr;
  if(!s?.session){
    location.href="login.html";
    return null;
  }
  return s.session;
}

async function requireAdmin(session){
  const { data: profile, error: pErr } = await sb
    .from("profiles")
    .select("is_admin")
    .eq("id", session.user.id)
    .single();

  if(pErr) throw pErr;

  if(!profile?.is_admin){
    alert("Not admin");
    return false;
  }
  return true;
}

/* ================= LOAD TABLE ================= */
async function load(){
  showNotice("");
  rowsEl.innerHTML = `<tr><td colspan="8">Loading...</td></tr>`;
  emptyEl.style.display = "none";

  try{
    const session = await requireSession();
    if(!session) return;

    const okAdmin = await requireAdmin(session);
    if(!okAdmin){
      rowsEl.innerHTML = "";
      return;
    }

    // ✅ Load deposits (receipt_url OR receipt_path) + transfer_number
    const { data, error } = await sb
      .from("deposits")
      .select("id,user_id,amount,method,status,created_at,receipt_url,receipt_path,transfer_number")
      .order("created_at", { ascending:false });

    if(error) throw error;

    if(!data || !data.length){
      rowsEl.innerHTML = "";
      emptyEl.style.display = "block";
      return;
    }

    rowsEl.innerHTML = "";
    for(const d of data){
      const st = String(d.status || "pending");
      const stClass =
        st==="approved" ? "ok" :
        st==="rejected" ? "no" : "pending";

      const receipt = String(d.receipt_url || d.receipt_path || "").trim();
      const transferNum = String(d.transfer_number || "").trim();

      rowsEl.innerHTML += `
        <tr>
          <td>${esc(d.id)}</td>

          <td>
            <div class="small">${esc(d.user_id)}</div>
          </td>

          <td><b>$${esc(d.amount)}</b></td>

          <td>${esc(d.method || "—")}</td>

          <td class="status ${stClass}">${esc(st)}</td>

          <td>
            ${
              receipt
                ? `<a class="actionBtn viewBtn" href="${esc(receipt)}" target="_blank" rel="noopener">View</a>`
                : `<span class="small" style="opacity:.55">—</span>`
            }
          </td>

          <td>
            ${
              transferNum
                ? `<span style="font-weight:900">${esc(transferNum)}</span>`
                : `<span class="small" style="opacity:.55">—</span>`
            }
          </td>

          <td>
            <button class="actionBtn okBtn" data-id="${esc(d.id)}" data-status="approved" title="Approve">✔</button>
            <button class="actionBtn noBtn" data-id="${esc(d.id)}" data-status="rejected" title="Reject">✖</button>
          </td>
        </tr>`;
    }

  }catch(e){
    rowsEl.innerHTML = `<tr><td colspan="8" style="color:#ffb4b4">Error:\n${esc(fmtErr(e))}</td></tr>`;
  }
}

/* ================= UPDATE STATUS =================
  ✅ Strategy:
  1) Try direct UPDATE on deposits (best / simplest).
  2) If blocked (RLS/permissions) fallback to RPC admin_set_deposit_status.
*/
async function setStatus(rawId, status){
  try{
    showNotice("");
    setBusy(true);

    const session = await requireSession();
    if(!session) return;

    const okAdmin = await requireAdmin(session);
    if(!okAdmin) return;

    const id = normalizeDepositId(rawId);

    if(status !== "approved" && status !== "rejected"){
      throw new Error("Invalid status");
    }

    // ---------- TRY #1: direct update deposits ----------
    const patch = { status: status };

    // (اختياري) إذا عندك أعمدة approved_at/updated_at رح تتعبّى
    patch.updated_at = new Date().toISOString();
    if(status === "approved") patch.approved_at = new Date().toISOString();

    const direct = await sb
      .from("deposits")
      .update(patch)
      .eq("id", id)
      .select("id,status")
      .single();

    if(!direct.error){
      await load();
      return;
    }

    // If direct failed, show in notice and fallback to RPC
    showNotice("Direct UPDATE failed, trying RPC...\n" + fmtErr(direct.error));

    // ---------- TRY #2: RPC fallback ----------
    const { error: rpcErr } = await sb.rpc("admin_set_deposit_status", {
      p_deposit_id: id,
      p_status: status
    });

    if(rpcErr) throw rpcErr;

    await load();

  }catch(e){
    console.log("setStatus error full:", e);
    alert(fmtErr(e));
  }finally{
    setBusy(false);
  }
}

/* ================= LOGOUT ================= */
async function logout(){
  await sb.auth.signOut();
  location.href="login.html";
}

/* ================= EVENTS ================= */
rowsEl.addEventListener("click", (ev)=>{
  const btn = ev.target.closest("button[data-id][data-status]");
  if(!btn) return;
  const id = btn.getAttribute("data-id");
  const status = btn.getAttribute("data-status");
  setStatus(id, status);
});

btnRefresh.addEventListener("click", load);
btnLogout.addEventListener("click", logout);

load();
</script>
</body>
</html>
