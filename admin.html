<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Deposit Requests</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0; min-height:100vh; font-family:system-ui,Arial;
      background:linear-gradient(160deg,#060b16,#0a1330);
      color:#eaf2ff; padding:16px;
    }
    .wrap{max-width:900px;margin:0 auto;}
    .top{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:14px;
    }
    .btn{
      border:0; padding:10px 14px; border-radius:12px; cursor:pointer;
      background:rgba(255,255,255,.10); color:#fff; font-weight:800;
    }
    .card{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:18px; padding:14px;
    }
    .statusBar{
      margin:10px 0 12px; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:rgba(234,242,255,.9);
      font-weight:800;
    }
    .errorBox{
      display:none;
      margin:12px 0; padding:12px; border-radius:14px;
      border:1px solid rgba(255,80,80,.35);
      background:rgba(255,80,80,.10);
      color:#ffd6d6; font-weight:700;
      white-space:pre-wrap;
    }
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px;}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); font-size:14px;}
    th{color:rgba(234,242,255,.75); text-align:left; font-weight:900;}
    .miniBtn{
      padding:8px 10px; border-radius:10px; border:0; cursor:pointer;
      color:#fff; font-weight:900; margin-right:6px;
      background:rgba(255,255,255,.12);
    }
    .miniBtn.ok{background:rgba(34,197,94,.22)}
    .miniBtn.no{background:rgba(239,68,68,.22)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h2 style="margin:0;">Admin – Deposit Requests</h2>
      <div>
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnLogout">Logout</button>
      </div>
    </div>

    <div class="card">
      <div id="statusBar" class="statusBar">Loading…</div>
      <div id="errorBox" class="errorBox"></div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Amount</th>
            <th>Method</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div id="empty" style="opacity:.7; padding:14px; display:none;">
        No deposits found.
      </div>
    </div>
  </div>

  <script>
    // ✅ لازم Anon Public Key (بيبلّش eyJ...) مش sb_publishable
    const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcndpdG9sb25oZmJmd3RzbmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjQyNTcsImV4cCI6MjA4MzA0MDI1N30.N-OqDDDOz1wJnKfmOFAtwlH00m_oJvUKEQvbygVeujQ"; // <-- بدّلها

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const rowsEl = document.getElementById("rows");
    const emptyEl = document.getElementById("empty");
    const errorBox = document.getElementById("errorBox");
    const statusBar = document.getElementById("statusBar");

    function setStatus(msg){ statusBar.textContent = msg; }
    function showError(msg){
      errorBox.style.display = "block";
      errorBox.textContent = msg;
    }
    function clearError(){
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }

    async function mustGetUser(){
      setStatus("Checking session…");
      const { data, error } = await supabase.auth.getSession();
      if(error) throw error;

      const user = data?.session?.user;
      if(!user){
        setStatus("Not logged in → redirecting…");
        location.replace("login.html?v=" + Date.now());
        return null;
      }
      return user;
    }

    async function requireAdmin(){
      const user = await mustGetUser();
      if(!user) return null;

      setStatus("Checking admin role…");
      const { data: prof, error: profErr } = await supabase
        .from("profiles")
        .select("id,is_admin")
        .eq("id", user.id)
        .single();

      if(profErr) throw profErr;

      if(!prof?.is_admin){
        setStatus("Access denied (not admin).");
        showError("Access denied: your profile is not admin.\nSet profiles.is_admin=true for your user.");
        return null;
      }

      return user;
    }

    async function loadDeposits(){
      clearError();
      rowsEl.innerHTML = "";
      emptyEl.style.display = "none";

      try{
        const admin = await requireAdmin();
        if(!admin) return;

        setStatus("Loading deposits…");
        const { data, error } = await supabase
          .from("deposits")
          .select("id,created_at,user_id,amount,method,status,receipt_path")
          .order("created_at", { ascending: false })
          .limit(100);

        if(error) throw error;

        if(!data || data.length === 0){
          setStatus("No deposits found.");
          emptyEl.style.display = "block";
          return;
        }

        setStatus(`Loaded ${data.length} deposit(s).`);

        for(const r of data){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.id}</td>
            <td style="font-size:12px; opacity:.9;">${r.user_id || "-"}</td>
            <td><b>${r.amount ?? "-"}</b></td>
            <td>${r.method || "-"}</td>
            <td><b>${r.status || "-"}</b></td>
            <td>
              <button class="miniBtn ok" data-act="approve" data-id="${r.id}">Approve</button>
              <button class="miniBtn no" data-act="reject" data-id="${r.id}">Reject</button>
              <button class="miniBtn" data-act="receipt" data-path="${r.receipt_path || ""}">Receipt</button>
            </td>
          `;
          rowsEl.appendChild(tr);
        }

      }catch(e){
        console.error(e);
        setStatus("Error.");
        showError("ERROR:\n" + (e?.message || JSON.stringify(e)));
      }
    }

    async function openReceipt(path){
      if(!path) return alert("No receipt path");

      // ✅ إذا bucket receipts private: نعمل signed url
      const { data: signed, error } = await supabase.storage
        .from("receipts")
        .createSignedUrl(path, 60);

      if(error){
        // fallback: public url إذا البكت public
        const { data: pub } = supabase.storage.from("receipts").getPublicUrl(path);
        const url = pub?.publicUrl;
        if(!url) return alert("Cannot open receipt. Check bucket settings.");
        window.open(url, "_blank");
        return;
      }

      window.open(signed.signedUrl, "_blank");
    }

    async function updateStatus(id, newStatus){
      clearError();
      try{
        const admin = await requireAdmin();
        if(!admin) return;

        if(!confirm(`Set deposit #${id} to ${newStatus}?`)) return;

        setStatus("Updating…");
        const { error } = await supabase
          .from("deposits")
          .update({ status: newStatus })
          .eq("id", id);

        if(error) throw error;

        alert(newStatus === "approved" ? "Approved ✅" : "Rejected ✅");
        loadDeposits();

      }catch(e){
        console.error(e);
        setStatus("Error.");
        showError("UPDATE ERROR:\n" + (e?.message || JSON.stringify(e)));
      }
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;

      const act = btn.dataset.act;
      if(act === "approve") return updateStatus(btn.dataset.id, "approved");
      if(act === "reject")  return updateStatus(btn.dataset.id, "rejected");
      if(act === "receipt") return openReceipt(btn.dataset.path);
    });

    document.getElementById("btnRefresh").addEventListener("click", loadDeposits);
    document.getElementById("btnLogout").addEventListener("click", async ()=>{
      await supabase.auth.signOut();
      location.replace("login.html?v=" + Date.now());
    });

    loadDeposits();
  </script>
</body>
</html>
