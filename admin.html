<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin – Deposit Requests</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:system-ui,Arial;
  background:linear-gradient(160deg,#060b16,#0a1330);
  color:#fff;
  padding:16px;
}
.wrap{max-width:1000px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;background:#1e293b;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #334155;font-size:14px}
th{color:#93c5fd;text-align:left}
.status{font-weight:bold}
.ok{color:#22c55e}
.no{color:#ef4444}
.pending{color:#fbbf24}

.actionBtn{
  padding:8px 10px;
  border-radius:10px;
  border:0;
  cursor:pointer;
  background:#1e293b;
  color:#fff;
  margin-right:6px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  text-decoration:none; /* مهم للرابط */
}
.actionBtn:active{transform:scale(.98)}
.actionBtn.okBtn{background:rgba(34,197,94,.15); border:1px solid rgba(34,197,94,.35)}
.actionBtn.noBtn{background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35)}
.actionBtn.viewBtn{background:rgba(59,130,246,.15); border:1px solid rgba(59,130,246,.35)}
.actionBtn:disabled{opacity:.55; cursor:not-allowed; transform:none}

.small{opacity:.75;font-size:12px}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <h2 style="margin:0;">Admin – Deposit Requests</h2>
    <div>
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>User</th>
        <th>Amount</th>
        <th>Method</th>
        <th>Status</th>
        <th>Receipt</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <p id="empty" style="display:none;opacity:.6">No deposits found</p>
</div>

<script>
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcndpdG9sb25oZmJmd3RzbmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjQyNTcsImV4cCI6MjA4MzA0MDI1N30.N-OqDDDOz1wJnKfmOFAtwlH00m_oJvUKEQvbygVeujQ";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const rowsEl = document.getElementById("rows");
const emptyEl = document.getElementById("empty");
const btnRefresh = document.getElementById("btnRefresh");
const btnLogout = document.getElementById("btnLogout");

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// ✅ deposits.id BIGINT فقط
function normalizeDepositId(raw){
  const s = String(raw ?? "").trim();
  const n = Number(s);
  if(!Number.isFinite(n)) throw new Error("Invalid deposit id");
  return n; // bigint
}

function setBusy(isBusy){
  btnRefresh.disabled = isBusy;
  btnLogout.disabled = isBusy;
  rowsEl.querySelectorAll("button.actionBtn").forEach(b => b.disabled = isBusy);
}

async function requireSession(){
  const { data: s, error: sErr } = await sb.auth.getSession();
  if(sErr) throw sErr;
  if(!s?.session){
    location.href="login.html";
    return null;
  }
  return s.session;
}

async function requireAdmin(session){
  // ✅ Admin check من profiles
  const { data: profile, error: pErr } = await sb
    .from("profiles")
    .select("is_admin")
    .eq("id", session.user.id)
    .single();

  if(pErr) throw pErr;

  if(!profile?.is_admin){
    alert("Not admin");
    return false;
  }
  return true;
}

async function load(){
  rowsEl.innerHTML = `<tr><td colspan="7">Loading...</td></tr>`;
  emptyEl.style.display = "none";

  try{
    const session = await requireSession();
    if(!session) return;

    const okAdmin = await requireAdmin(session);
    if(!okAdmin){
      rowsEl.innerHTML = "";
      return;
    }

    // ✅ Load deposits (ضيفنا receipt_url)
    const { data, error } = await sb
      .from("deposits")
      .select("id,user_id,amount,method,status,created_at,receipt_url")
      .order("created_at", { ascending:false });

    if(error) throw error;

    if(!data || !data.length){
      rowsEl.innerHTML = "";
      emptyEl.style.display = "block";
      return;
    }

    // ✅ Render
    rowsEl.innerHTML = "";
    for(const d of data){
      const st = String(d.status || "pending");
      const stClass =
        st==="approved" ? "ok" :
        st==="rejected" ? "no" : "pending";

      const receipt = (d.receipt_url ?? "").toString().trim();

      rowsEl.innerHTML += `
        <tr>
          <td>${esc(d.id)}</td>
          <td>
            <div class="small">${esc(d.user_id)}</div>
          </td>
          <td><b>$${esc(d.amount)}</b></td>
          <td>${esc(d.method)}</td>
          <td class="status ${stClass}">${esc(st)}</td>

          <td>
            ${
              receipt
                ? `<a class="actionBtn viewBtn" href="${esc(receipt)}" target="_blank" rel="noopener">View</a>`
                : `<span class="small" style="opacity:.55">—</span>`
            }
          </td>

          <td>
            <button class="actionBtn okBtn" data-id="${esc(d.id)}" data-status="approved" title="Approve">✔</button>
            <button class="actionBtn noBtn" data-id="${esc(d.id)}" data-status="rejected" title="Reject">✖</button>
          </td>
        </tr>`;
    }

  }catch(e){
    rowsEl.innerHTML = `<tr><td colspan="7" style="color:#ffb4b4">Error: ${esc(e?.message || e)}</td></tr>`;
  }
}

async function setStatus(rawId, status){
  try{
    setBusy(true);

    const session = await requireSession();
    if(!session) return;

    const okAdmin = await requireAdmin(session);
    if(!okAdmin) return;

    const id = normalizeDepositId(rawId);

    // ✅ RPC: admin_set_deposit_status(p_deposit_id bigint, p_status text)
    const { error } = await sb.rpc("admin_set_deposit_status", {
      p_deposit_id: id,
      p_status: status
    });

    if(error) throw error;

    await load();
  }catch(e){
    alert(e?.message || e);
  }finally{
    setBusy(false);
  }
}

async function logout(){
  await sb.auth.signOut();
  location.href="login.html";
}

// ✅ Event delegation
rowsEl.addEventListener("click", (ev)=>{
  const btn = ev.target.closest("button[data-id][data-status]");
  if(!btn) return;
  const id = btn.getAttribute("data-id");
  const status = btn.getAttribute("data-status");
  setStatus(id, status);
});

btnRefresh.addEventListener("click", load);
btnLogout.addEventListener("click", logout);

load();
</script>
<script src="app-ui.js?v=1"></script>
</body>
</html>
