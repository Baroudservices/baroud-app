<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin – Deposit Requests</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:system-ui,Arial;
  background:linear-gradient(160deg,#060b16,#0a1330);
  color:#fff;
  padding:16px;
}
.wrap{max-width:1000px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;background:#1e293b;color:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #334155;font-size:14px}
th{color:#93c5fd;text-align:left}
.status{font-weight:bold}
.ok{color:#22c55e}
.no{color:#ef4444}

/* Buttons inside table */
.actionBtn{
  padding:8px 10px;
  border-radius:10px;
  border:0;
  cursor:pointer;
  background:#1e293b;
  color:#fff;
  margin-right:6px;
}
.actionBtn:active{transform:scale(.98)}
.actionBtn.okBtn{background:rgba(34,197,94,.15); border:1px solid rgba(34,197,94,.35)}
.actionBtn.noBtn{background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35)}
.actionBtn:disabled{opacity:.55; cursor:not-allowed; transform:none}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <h2>Admin – Deposit Requests</h2>
    <div>
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>User</th>
        <th>Amount</th>
        <th>Method</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <p id="empty" style="display:none;opacity:.6">No deposits found</p>
</div>

<script>
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcndpdG9sb25oZmJmd3RzbmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjQyNTcsImV4cCI6MjA4MzA0MDI1N30.N-OqDDDOz1wJnKfmOFAtwlH00m_oJvUKEQvbygVeujQ";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const rowsEl = document.getElementById("rows");
const emptyEl = document.getElementById("empty");
const btnRefresh = document.getElementById("btnRefresh");
const btnLogout = document.getElementById("btnLogout");

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// إذا id رقم => bigint ، إذا uuid => string
function normalizeDepositId(raw){
  const s = String(raw ?? "").trim();
  // digits only => send as Number (bigint)
  if (/^\d+$/.test(s)) return Number(s);
  // otherwise keep as string (uuid)
  return s;
}

function setBusy(isBusy){
  btnRefresh.disabled = isBusy;
  btnLogout.disabled = isBusy;
  rowsEl.querySelectorAll("button.actionBtn").forEach(b => b.disabled = isBusy);
}

async function load(){
  rowsEl.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;
  emptyEl.style.display = "none";

  try{
    const { data: s, error: sErr } = await sb.auth.getSession();
    if(sErr) throw sErr;
    if(!s?.session){ location.href="login.html"; return; }

    // ✅ Admin check
    const { data: profile, error: pErr } = await sb
      .from("profiles")
      .select("is_admin")
      .eq("id", s.session.user.id)
      .single();

    if(pErr) throw pErr;

    if(!profile?.is_admin){
      alert("Not admin");
      rowsEl.innerHTML = "";
      return;
    }

    // ✅ Load deposits
    const { data, error } = await sb
      .from("deposits")
      .select("*")
      .order("created_at",{ascending:false});

    if(error) throw error;

    if(!data || !data.length){
      rowsEl.innerHTML = "";
      emptyEl.style.display = "block";
      return;
    }

    // ✅ Render rows
    rowsEl.innerHTML = "";
    for(const d of data){
      const st = String(d.status || "pending");
      const stClass = st==="approved" ? "ok" : st==="rejected" ? "no" : "";
      rowsEl.innerHTML += `
        <tr>
          <td>${esc(d.id)}</td>
          <td>${esc(d.user_id)}</td>
          <td>$${esc(d.amount)}</td>
          <td>${esc(d.method)}</td>
          <td class="status ${stClass}">${esc(st)}</td>
          <td>
            <button class="actionBtn okBtn" data-id="${esc(d.id)}" data-status="approved" title="Approve">✔</button>
            <button class="actionBtn noBtn" data-id="${esc(d.id)}" data-status="rejected" title="Reject">✖</button>
          </td>
        </tr>`;
    }

  }catch(e){
    rowsEl.innerHTML = `<tr><td colspan="6" style="color:#ffb4b4">Error: ${esc(e?.message || e)}</td></tr>`;
  }
}

async function setStatus(rawId, status){
  try{
    setBusy(true);

    const id = normalizeDepositId(rawId);

    // ✅ RPC (RLS safe) via function
    const { error } = await sb.rpc("admin_set_deposit_status", {
      p_deposit_id: id,
      p_status: status
    });

    if(error) throw error;

    await load();
  }catch(e){
    alert(e?.message || e);
  }finally{
    setBusy(false);
  }
}

async function logout(){
  await sb.auth.signOut();
  location.href="login.html";
}

// ✅ Event delegation
rowsEl.addEventListener("click", (ev)=>{
  const btn = ev.target.closest("button[data-id][data-status]");
  if(!btn) return;
  const id = btn.getAttribute("data-id");
  const status = btn.getAttribute("data-status");
  setStatus(id, status);
});

btnRefresh.addEventListener("click", load);
btnLogout.addEventListener("click", logout);

load();
</script>
</body>
</html>
