<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Deposit Requests</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0; min-height:100vh; font-family:system-ui,Arial;
      background:linear-gradient(160deg,#060b16,#0a1330);
      color:#eaf2ff; padding:16px;
    }
    .wrap{max-width:900px;margin:0 auto;}
    .top{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:14px;
    }
    .btn{
      border:0; padding:10px 14px; border-radius:12px; cursor:pointer;
      background:rgba(255,255,255,.10); color:#fff; font-weight:800;
    }
    .card{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:18px; padding:14px;
    }
    .errorBox{
      display:none;
      margin:12px 0; padding:12px; border-radius:14px;
      border:1px solid rgba(255,80,80,.35);
      background:rgba(255,80,80,.10);
      color:#ffd6d6; font-weight:700;
      white-space:pre-wrap;
    }
    .infoBox{
      margin:12px 0; padding:12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(234,242,255,.85);
      font-weight:700;
      white-space:pre-wrap;
    }
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px;}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); font-size:14px;}
    th{color:rgba(234,242,255,.75); text-align:left; font-weight:900;}
    .miniBtn{
      padding:8px 10px; border-radius:10px; border:0; cursor:pointer;
      color:#fff; font-weight:900; margin-right:6px;
      background:rgba(255,255,255,.12);
    }
    .miniBtn.ok{background:rgba(34,197,94,.22)}
    .miniBtn.no{background:rgba(239,68,68,.22)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h2 style="margin:0;">Admin – Deposit Requests</h2>
      <div>
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnLogout">Logout</button>
      </div>
    </div>

    <div class="card">
      <div id="errorBox" class="errorBox"></div>

      <!-- ✅ Debug مهم: بيقلك إذا في session + إذا انت admin -->
      <div id="infoBox" class="infoBox">Checking session...</div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Amount</th>
            <th>Method</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div id="empty" style="opacity:.7; padding:14px; display:none;">
        No deposits found.
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
    const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const rowsEl  = document.getElementById("rows");
    const emptyEl = document.getElementById("empty");
    const errorBox= document.getElementById("errorBox");
    const infoBox = document.getElementById("infoBox");

    let cachedUser = null;
    let cachedIsAdmin = false;

    function showError(msg){
      errorBox.style.display = "block";
      errorBox.textContent = msg;
    }
    function clearError(){
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }
    function setInfo(msg){
      infoBox.textContent = msg;
    }

    async function requireAdmin(){
      clearError();

      // ✅ 1) session
      const { data: sessionData, error: sessionErr } = await supabase.auth.getSession();
      if(sessionErr) throw sessionErr;

      const user = sessionData?.session?.user;
      if(!user){
        setInfo("No session ❌ (Not logged in)\nRedirecting to login...");
        location.replace("login.html?v=" + Date.now());
        return null;
      }

      // ✅ 2) read profile => is_admin
      const { data: prof, error: profErr } = await supabase
        .from("profiles")
        .select("id, is_admin")
        .eq("id", user.id)
        .single();

      if(profErr) throw profErr;

      if(!prof?.is_admin){
        setInfo("Logged in ✅\nUser: " + user.id + "\nAdmin: NO ❌");
        showError("Access denied: you are not admin.");
        return null;
      }

      cachedUser = user;
      cachedIsAdmin = true;
      setInfo("Logged in ✅\nUser: " + user.id + "\nAdmin: YES ✅\nOrigin: " + location.origin);

      return user;
    }

    async function loadDeposits(){
      clearError();
      rowsEl.innerHTML = "";
      emptyEl.style.display = "none";

      const adminUser = await requireAdmin();
      if(!adminUser) return;

      const { data, error } = await supabase
        .from("deposits")
        .select("id, created_at, user_id, amount, method, status, receipt_path")
        .order("created_at", { ascending: false })
        .limit(100);

      if(error){
        showError("LOAD ERROR:\n" + (error.message || JSON.stringify(error)));
        return;
      }

      if(!data || data.length === 0){
        emptyEl.style.display = "block";
        return;
      }

      for(const r of data){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td>
          <td style="font-size:12px; opacity:.9;">${r.user_id || "-"}</td>
          <td><b>${r.amount ?? "-"}</b></td>
          <td>${r.method || "-"}</td>
          <td style="font-weight:900;">${r.status || "-"}</td>
          <td>
            <button class="miniBtn ok" data-act="approve" data-id="${r.id}">Approve</button>
            <button class="miniBtn no" data-act="reject" data-id="${r.id}">Reject</button>
            <button class="miniBtn" data-act="receipt" data-path="${r.receipt_path || ""}">Receipt</button>
          </td>
        `;
        rowsEl.appendChild(tr);
      }
    }

    async function openReceipt(path){
      if(!path) return alert("No receipt path");

      // ✅ إذا bucket public بيشتغل publicUrl
      const { data: pub } = supabase.storage.from("receipts").getPublicUrl(path);
      const publicUrl = pub?.publicUrl;

      // جرّب public أولًا
      if(publicUrl){
        // ملاحظة: publicUrl موجود دائمًا، بس إذا bucket private ممكن الرابط يفتح error
        // لذلك منجرّب signed كخيار “آمن”
      }

      // ✅ Signed URL (شغّال حتى لو bucket private)
      const { data, error } = await supabase.storage
        .from("receipts")
        .createSignedUrl(path, 60 * 10); // 10 min

      if(error){
        alert("Cannot open receipt: " + error.message);
        return;
      }

      window.open(data.signedUrl, "_blank");
    }

    async function updateStatus(id, newStatus){
      clearError();

      const adminUser = await requireAdmin();
      if(!adminUser) return;

      const ok = confirm(`Set deposit #${id} to ${newStatus}?`);
      if(!ok) return;

      const { error } = await supabase
        .from("deposits")
        .update({ status: newStatus })
        .eq("id", id);

      if(error){
        showError("UPDATE ERROR:\n" + (error.message || JSON.stringify(error)));
        return;
      }

      alert(newStatus === "approved" ? "Approved ✅" : "Rejected ✅");
      loadDeposits();
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;

      const act = btn.dataset.act;
      if(act === "approve") return updateStatus(btn.dataset.id, "approved");
      if(act === "reject")  return updateStatus(btn.dataset.id, "rejected");
      if(act === "receipt") return openReceipt(btn.dataset.path);
    });

    document.getElementById("btnRefresh").addEventListener("click", loadDeposits);
    document.getElementById("btnLogout").addEventListener("click", async ()=>{
      await supabase.auth.signOut();
      location.replace("login.html?v=" + Date.now());
    });

    // ✅ مهم: استنى auth يثبت (حل مشكلة “فاضي”)
    supabase.auth.onAuthStateChange((_event, session) => {
      if(session) loadDeposits();
      else setInfo("No session ❌ (Not logged in)\nOrigin: " + location.origin);
    });

    // أول تحميل
    loadDeposits();
  </script>
</body>
</html>
