<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register - Baroud Services</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:system-ui,Arial;
  background:linear-gradient(180deg,#0b1424,#050a14);
  color:#fff;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
.card{
  width:100%;
  max-width:420px;
  background:rgba(255,255,255,.06);
  border-radius:22px;
  padding:20px;
  box-shadow:0 18px 70px rgba(0,0,0,.45);
}
h1{text-align:center}
label{font-size:12px;opacity:.7}
input{
  width:100%;
  padding:12px;
  margin-top:6px;
  margin-bottom:12px;
  border-radius:14px;
  background:rgba(0,0,0,.25);
  border:1px solid rgba(255,255,255,.12);
  color:#fff;
}
button{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:0;
  background:linear-gradient(90deg,#0aa0ff,#2a74ff);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.msg{margin-top:10px;font-weight:900}
.ok{color:#22c55e}
.bad{color:#ef4444}
.otpBox{
  display:none;
  margin-top:16px;
  padding:14px;
  background:rgba(0,0,0,.25);
  border-radius:16px;
}
</style>
</head>

<body>
<div class="card">
<h1>Register</h1>

<label>Email</label>
<input id="email" type="email" placeholder="name@email.com">

<label>Phone Number</label>
<input id="phone" type="tel" value="+961">

<label>Password</label>
<input id="pass" type="password">

<label>Confirm Password</label>
<input id="pass2" type="password">

<button id="createBtn">Create Account</button>

<div id="msg" class="msg"></div>

<div class="otpBox" id="otpBox">
  <label>Verification Code</label>
  <input id="otpCode" placeholder="123456">
  <button id="verifyBtn">Verify</button>
</div>
</div>

<script>
/* âœ… SUPABASE */
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcndpdG9sb25oZmJmd3RzbmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjQyNTcsImV4cCI6MjA4MzA0MDI1N30.N-OqDDDOz1wJnKfmOFAtwlH00m_oJvUKEQvbygVeujQ";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* âœ… ELEMENTS (ØµØ­) */
const emailEl = document.getElementById("email");
const phoneEl = document.getElementById("phone");
const passEl = document.getElementById("pass");
const pass2El = document.getElementById("pass2");
const createBtn = document.getElementById("createBtn");
const msgEl = document.getElementById("msg");
const otpBox = document.getElementById("otpBox");
const otpCode = document.getElementById("otpCode");
const verifyBtn = document.getElementById("verifyBtn");

let LAST_PHONE = "";

/* ðŸ”’ ÙØ±Ø¶ +961 */
phoneEl.addEventListener("input", ()=>{
  if(!phoneEl.value.startsWith("+961")){
    phoneEl.value = "+961";
  }
});

/* ðŸ§  helpers */
function showMsg(t, ok=false){
  msgEl.className = "msg " + (ok ? "ok":"bad");
  msgEl.textContent = t;
}

/* ðŸ“ž call edge fn */
async function callFn(name, body){
  const { data:{session} } = await sb.auth.getSession();
  const res = await fetch(`${SUPABASE_URL}/functions/v1/${name}`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + (session?.access_token || SUPABASE_KEY)
    },
    body:JSON.stringify(body)
  });
  if(!res.ok) throw new Error("Function error");
}

/* ðŸš€ REGISTER */
createBtn.onclick = async ()=>{
  showMsg("");

  const email = emailEl.value.trim().toLowerCase();
  const phone = phoneEl.value.trim();
  const pass = passEl.value;
  const pass2 = pass2El.value;

  if(!email) return showMsg("Enter email");
  if(!phone.startsWith("+961") || phone.length < 11) return showMsg("Invalid Lebanese number");
  if(pass.length < 6) return showMsg("Password too short");
  if(pass !== pass2) return showMsg("Passwords do not match");

  const { error } = await sb.auth.signUp({
    email,
    password: pass,
    options:{ data:{ phone } }
  });

  if(error) return showMsg(error.message);

  const { data } = await sb.auth.signInWithPassword({ email, password: pass });
  if(!data?.session) return showMsg("Check your email");

  LAST_PHONE = phone;
  otpBox.style.display = "block";

  await callFn("twilio-send-otp",{ phone });
  showMsg("SMS code sent", true);
};

/* âœ… VERIFY */
verifyBtn.onclick = async ()=>{
  try{
    await callFn("twilio-verify-otp",{ phone:LAST_PHONE, code:otpCode.value });
    showMsg("Verified! Redirecting...", true);
    location.href = "services.html";
  }catch{
    showMsg("Wrong code");
  }
};
</script>
</body>
</html>
