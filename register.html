<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register - Baroud Services</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --shadow:0 18px 70px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, Arial;
      background:linear-gradient(180deg,#0b1424,#050a14);
      color:#fff; min-height:100vh; padding:16px;
      display:flex; align-items:center; justify-content:center;
    }
    .wrap{width:min(520px,100%)}
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px;
    }
    .brand{font-weight:950; text-align:center; opacity:.9}
    h1{text-align:center;margin:10px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.row{grid-template-columns:1fr}}
    label{font-size:12px;opacity:.7}
    input{
      width:100%;padding:12px;border-radius:14px;
      background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);
      color:#fff;font-size:14px;
    }
    .btn{
      width:100%;margin-top:12px;padding:12px;
      border-radius:14px;border:0;cursor:pointer;
      background:linear-gradient(90deg,#0aa0ff,#2a74ff);
      color:#fff;font-weight:900;
    }
    .btn.secondary{background:rgba(255,255,255,.1)}
    .msg{margin-top:10px;font-weight:900}
    .ok{color:#22c55e}
    .bad{color:#ef4444}

    .otpBox{
      display:none;margin-top:14px;padding:14px;
      border-radius:18px;background:rgba(0,0,0,.2);
      border:1px solid rgba(255,255,255,.1);
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="brand">Baroud Services</div>
    <h1>Register</h1>

    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="name@email.com">
      </div>
      <div>
        <label>Phone Number</label>
        <input id="phone" type="tel" value="+961" placeholder="+961XXXXXXXX">
      </div>
      <div>
        <label>Password</label>
        <input id="pass" type="password">
      </div>
      <div>
        <label>Confirm Password</label>
        <input id="pass2" type="password">
      </div>
    </div>

    <button class="btn" id="btn">Create Account</button>
    <div class="msg" id="msg"></div>

    <!-- OTP -->
    <div class="otpBox" id="otpBox">
      <p><b>Verify phone number</b></p>
      <input id="otpCode" placeholder="6-digit code">
      <button class="btn secondary" id="resendBtn">Resend</button>
      <button class="btn" id="verifyBtn">Verify</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const elEmail = email;
const elPhone = phone;
const elPass = pass;
const elPass2 = pass2;
const btn = btn;
const msg = document.getElementById("msg");
const otpBox = document.getElementById("otpBox");
const otpCode = document.getElementById("otpCode");

let LAST_PHONE = "";

function showMsg(t, ok=false){
  msg.className = "msg " + (ok ? "ok":"bad");
  msg.textContent = t;
}

/* ðŸ”’ ÙØ±Ø¶ +961 */
elPhone.addEventListener("input", ()=>{
  if(!elPhone.value.startsWith("+961")){
    elPhone.value = "+961";
  }
});

/* ðŸ“² Call edge function */
async function callFn(name, body){
  const { data:{session} } = await sb.auth.getSession();
  const res = await fetch(`${SUPABASE_URL}/functions/v1/${name}`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + (session?.access_token || SUPABASE_KEY)
    },
    body:JSON.stringify(body)
  });
  if(!res.ok) throw new Error("Failed");
}

/* ðŸš€ Register */
btn.onclick = async ()=>{
  msg.textContent="";
  const email = elEmail.value.trim().toLowerCase();
  const phone = elPhone.value.trim();
  const pass = elPass.value;
  const pass2 = elPass2.value;

  if(!email) return showMsg("Enter email");
  if(!phone.startsWith("+961") || phone.length < 11) return showMsg("Phone must be Lebanese (+961)");
  if(pass.length < 6) return showMsg("Password too short");
  if(pass !== pass2) return showMsg("Passwords do not match");

  const { error } = await sb.auth.signUp({
    email,
    password: pass,
    options:{ data:{ phone } }
  });

  if(error) return showMsg(error.message);

  const { data } = await sb.auth.signInWithPassword({ email, password: pass });
  if(!data?.session) return showMsg("Check your email first");

  LAST_PHONE = phone;
  otpBox.style.display="block";
  await callFn("twilio-send-otp",{ phone });
  showMsg("SMS code sent", true);
};

/* âœ… Verify OTP */
verifyBtn.onclick = async ()=>{
  try{
    await callFn("twilio-verify-otp",{ phone:LAST_PHONE, code:otpCode.value });
    showMsg("Verified! Redirecting...", true);
    location.replace("services.html");
  }catch{
    showMsg("Wrong code");
  }
};
</script>
</body>
</html>
