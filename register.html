<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - Baroud Services</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0; min-height:100vh; display:flex; justify-content:center; align-items:center;
      background:linear-gradient(180deg,#0b1424,#050a14);
      font-family:system-ui,Arial; color:#fff;
      padding:16px;
    }
    .card{
      width:100%; max-width:420px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:22px; padding:20px;
      box-shadow:0 20px 50px rgba(0,0,0,0.3);
    }
    h1{text-align:center;margin:10px 0;font-weight:900;letter-spacing:1px;}
    label{font-size:12px;opacity:.7;font-weight:600;margin-left:5px;}
    input{
      width:100%; margin:6px 0 12px; padding:14px;
      border-radius:14px; border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.25); color:#fff; outline:none;
    }
    input:focus{border-color:#0aa0ff;}
    button{
      width:100%; padding:14px; border-radius:16px; border:0;
      font-weight:900; background:linear-gradient(90deg,#0aa0ff,#2a74ff);
      color:#fff; cursor:pointer;
    }
    button:disabled{opacity:.6; cursor:not-allowed;}
    .msg{margin-top:12px;font-weight:900;text-align:center;min-height:22px;white-space:pre-wrap}
    .ok{color:#22c55e}
    .bad{color:#ef4444}
    .otpBox{
      display:none; margin-top:16px; padding:14px;
      border-radius:16px; background:rgba(0,0,0,.2);
      border:1px solid rgba(255,255,255,0.1);
    }
    .row{display:flex; gap:10px}
    .row button{width:50%}
    .secondary{background:#1f2937}
    .back-link{
      display:block;text-align:center;margin-top:15px;
      color:rgba(255,255,255,0.5);text-decoration:none;font-size:13px;
    }
  </style>
</head>

<body>
<div class="card">
  <h1>Register</h1>

  <label>Email</label>
  <input id="email" type="email" placeholder="Enter your email" autocomplete="email">

  <label>Phone Number</label>
  <input id="phone" type="tel" placeholder="+961XXXXXXXX" inputmode="numeric">

  <label>Password</label>
  <input id="pass" type="password" placeholder="••••••••" autocomplete="new-password">

  <label>Confirm Password</label>
  <input id="pass2" type="password" placeholder="••••••••" autocomplete="new-password">

  <button id="btn">Create Account</button>
  <div class="msg" id="msg"></div>

  <div class="otpBox" id="otpBox">
    <label>Verification Code</label>
    <input id="otp" placeholder="123456" maxlength="6" inputmode="numeric">
    <div class="row">
      <button class="secondary" id="resend" type="button">Resend</button>
      <button id="verify" type="button">Verify</button>
    </div>
  </div>

  <a href="index.html" class="back-link">Back to Home</a>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_"; // <-- مهم

const FN_SEND = "send-phone-otp";
const FN_CHECK = "check-phone-otp";

/* ================= INIT ================= */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

const elEmail = document.getElementById("email");
const elPhone = document.getElementById("phone");
const elPass  = document.getElementById("pass");
const elPass2 = document.getElementById("pass2");
const btn     = document.getElementById("btn");
const msg     = document.getElementById("msg");

const otpBox  = document.getElementById("otpBox");
const otp     = document.getElementById("otp");
const resend  = document.getElementById("resend");
const verify  = document.getElementById("verify");

let LAST_PHONE = "";

/* ================= HELPERS ================= */
function show(text, ok=false){
  msg.className = "msg " + (ok ? "ok" : "bad");
  msg.textContent = text || "";
}

function setLoading(on, text){
  btn.disabled = on;
  btn.textContent = on ? (text || "Please wait...") : "Create Account";
}

/* ✅ phone: اجبار +961 */
function cleanPhone(v){
  let digits = String(v || "").replace(/\D/g, ""); // فقط أرقام

  // شيل 961 إذا مكتوبة بالبداية لحتى ما تتكرر
  if (digits.startsWith("961")) digits = digits.slice(3);

  // لبنان عادة 8 أرقام بعد +961
  digits = digits.slice(0, 8);

  return "+961" + digits;
}

elPhone.addEventListener("focus", () => {
  if(!elPhone.value) elPhone.value = "+961";
});

elPhone.addEventListener("input", () => {
  elPhone.value = cleanPhone(elPhone.value);
});

/* ================= EDGE INVOKE (الأفضل) ================= */
async function invokeFn(name, body){
  const { data, error } = await sb.functions.invoke(name, { body });
  if (error) throw error;
  return data;
}

function getPrettyError(err){
  // يعطيك سبب واضح بدل Failed to fetch
  if (!err) return "Unknown error";
  if (typeof err === "string") return err;
  if (err.message) return err.message;
  try { return JSON.stringify(err); } catch(e) { return "Error"; }
}

/* ================= REGISTER ================= */
btn.addEventListener("click", async () => {
  show("");

  const email = elEmail.value.trim().toLowerCase();
  const phone = elPhone.value.trim();
  const pass  = elPass.value;
  const pass2 = elPass2.value;

  if(!email) return show("Enter email");
  if(!phone.startsWith("+961") || phone.length !== 12) return show("Phone must be like +961XXXXXXXX");
  if(pass.length < 6) return show("Password must be at least 6 chars");
  if(pass !== pass2) return show("Passwords do not match");

  setLoading(true, "Creating...");

  try{
    // 1) Sign up
    const { error: signUpErr } = await sb.auth.signUp({
      email,
      password: pass,
      options: { data: { phone } }
    });
    if(signUpErr) throw signUpErr;

    // 2) Sign in مباشرة (إذا Confirm Email ON يمكن يفشل)
    const { data: signInData, error: signInErr } = await sb.auth.signInWithPassword({ email, password: pass });
    if(signInErr || !signInData?.session){
      show("✅ Account created.\nConfirm your email then login.", true);
      return;
    }

    // 3) Send OTP
    LAST_PHONE = phone;
    otpBox.style.display = "block";
    show("Sending SMS code...", true);

    await invokeFn(FN_SEND, { phone });

    show("✅ Code sent to " + phone, true);

  }catch(err){
    show("❌ " + getPrettyError(err));
  }finally{
    setLoading(false);
  }
});

/* ================= VERIFY ================= */
verify.addEventListener("click", async () => {
  const code = otp.value.trim();
  if(code.length < 4) return show("Enter the code");

  verify.disabled = true;
  verify.textContent = "Verifying...";

  try{
    await invokeFn(FN_CHECK, { phone: LAST_PHONE, code });

    show("✅ Phone verified! Redirecting...", true);
    setTimeout(() => location.replace("services.html?v=" + Date.now()), 700);

  }catch(err){
    show("❌ " + getPrettyError(err));
  }finally{
    verify.disabled = false;
    verify.textContent = "Verify";
  }
});

/* ================= RESEND ================= */
resend.addEventListener("click", async () => {
  if(!LAST_PHONE) return;
  resend.disabled = true;
  resend.textContent = "Sending...";

  try{
    await invokeFn(FN_SEND, { phone: LAST_PHONE });
    show("✅ Code resent.", true);
  }catch(err){
    show("❌ " + getPrettyError(err));
  }finally{
    resend.disabled = false;
    resend.textContent = "Resend";
  }
});
</script>
</body>
</html>
