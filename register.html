<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register - Baroud Services</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --shadow:0 18px 70px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, Arial;
      background:linear-gradient(180deg,#0b1424,#050a14);
      color:#fff; min-height:100vh; padding:16px;
      display:flex; align-items:center; justify-content:center;
    }
    .wrap{width:min(520px,100%)}
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px;
    }
    .brand{font-weight:950; text-align:center; opacity:.9; letter-spacing:.6px}
    h1{margin:10px 0 6px; font-size:26px; text-align:center}
    .sub{opacity:.7; text-align:center; margin-bottom:14px}
    label{display:block; font-size:12px; opacity:.75; margin:10px 0 6px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:#fff;
      outline:none;
      font-size:14px;
    }
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      color:#fff;
      font-weight:950;
      background:linear-gradient(90deg,#0aa0ff,#2a74ff);
      margin-top:12px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }
    .msg{margin-top:12px; font-size:13px; opacity:.95; font-weight:800}
    .ok{color:#22c55e}
    .bad{color:#ef4444}
    .links{margin-top:12px; display:flex; justify-content:space-between; gap:10px; opacity:.85; font-weight:800}
    a{color:#7dd3fc; text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">Baroud Services</div>
      <h1>Register</h1>
      <div class="sub">Create your account</div>

      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="name@email.com" autocomplete="email"/>
        </div>
        <div>
          <label>Phone Number</label>
          <input id="phone" type="tel" placeholder="+961..." autocomplete="tel"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Password</label>
          <input id="pass" type="password" placeholder="Min 6 characters" autocomplete="new-password"/>
        </div>
        <div>
          <label>Confirm Password</label>
          <input id="pass2" type="password" placeholder="Repeat password" autocomplete="new-password"/>
        </div>
      </div>

      <button class="btn" id="btn">Create Account</button>
      <div class="msg" id="msg"></div>

      <div class="links">
        <a href="login.html">Login</a>
        <a href="send-email-request.html">Forgot password?</a>
      </div>
    </div>
  </div>

<script>
  // Supabase
  const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcndpdG9sb25oZmJmd3RzbmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjQyNTcsImV4cCI6MjA4MzA0MDI1N30.N-OqDDDOz1wJnKfmOFAtwlH00m_oJvUKEQvbygVeujQ";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Base URL ديناميكي (يحافظ على /baroud-app/)
  function getBaseUrl(){
    const basePath = location.pathname.replace(/[^\/]*$/, "");
    return location.origin + basePath;
  }
  const BASE_URL = getBaseUrl();

  const elEmail = document.getElementById("email");
  const elPhone = document.getElementById("phone");
  const elPass  = document.getElementById("pass");
  const elPass2 = document.getElementById("pass2");
  const btn = document.getElementById("btn");
  const msg = document.getElementById("msg");

  function showMsg(t, ok=false){
    msg.className = "msg " + (ok ? "ok" : "bad");
    msg.textContent = t || "";
  }
  function setLoading(on, text){
    btn.disabled = !!on;
    btn.textContent = on ? (text || "Please wait...") : "Create Account";
  }
  function cleanPhone(s){
    return String(s || "").replace(/\s+/g, "").trim();
  }

  // إذا في جلسة (ومش جايي من recovery) رجّعو
  (async ()=>{
    try{
      const { data: { session } } = await sb.auth.getSession();
      const params = new URLSearchParams(window.location.search);
      const isRecovery = params.get("type") === "recovery";
      if(session && !isRecovery){
        location.replace("services.html");
      }
    }catch(e){}
  })();

  // ✅ فحص الإيميل إذا موجود عبر Edge Function
  async function emailExists(email){
    const url = SUPABASE_URL + "/functions/v1/check-email";
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        // مهم: لازم Bearer للـ anon key
        "Authorization": "Bearer " + SUPABASE_KEY
      },
      body: JSON.stringify({ email })
    });

    // لو صار خطأ بالشبكة/الفنكشن
    if(!res.ok){
      // بنرجّع null يعني ما قدرنا نفحص
      return null;
    }

    const j = await res.json().catch(()=> ({}));
    // نتوقع j.exists true/false
    return !!j.exists;
  }

  async function doRegister(){
    showMsg("");

    const email = String(elEmail.value || "").trim().toLowerCase();
    const phone = cleanPhone(elPhone.value);
    const pass  = String(elPass.value || "").trim();
    const pass2 = String(elPass2.value || "").trim();

    if(!email) return showMsg("Enter your email.");
    if(!phone) return showMsg("Enter your phone number.");
    if(pass.length < 6) return showMsg("Password must be at least 6 characters.");
    if(pass !== pass2) return showMsg("Passwords do not match.");
    if(btn.disabled) return;

    setLoading(true, "Checking...");

    try{
      // 1) check email exists
      const exists = await emailExists(email);

      if(exists === true){
        showMsg("❌ This email already has an account. Please login instead.");
        return;
      }

      // لو exists = null يعني الفنكشن ما ردّت
      // منكمّل عادي بس مننبه (اختياري)
      // if(exists === null){}

      setLoading(true, "Creating...");

      // 2) sign up
      const { error } = await sb.auth.signUp({
        email,
        password: pass,
        options:{
          data: { phone }, // user_metadata
          emailRedirectTo: BASE_URL + "login.html"
        }
      });

      if(error){
        const m = String(error.message || "").toLowerCase();
        const looksLikeEmailExists =
          m.includes("already") ||
          m.includes("registered") ||
          m.includes("exists") ||
          m.includes("duplicate");

        if(looksLikeEmailExists){
          showMsg("❌ This email already has an account. Please login instead.");
          return;
        }

        showMsg(error.message || "Register failed.");
        return;
      }

      showMsg("✅ Account created! Check your email to confirm.", true);

    }catch(e){
      showMsg("Network error. Try again.");
    }finally{
      setLoading(false);
    }
  }

  btn.addEventListener("click", doRegister);

  elPass2.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") doRegister();
  });
</script>
</body>
</html>
