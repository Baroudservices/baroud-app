<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - Baroud Services</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      background:linear-gradient(180deg,#0b1424,#050a14);
      font-family:system-ui,Arial;
      color:#fff;
      padding:16px;
    }
    .card{
      width:100%;
      max-width:420px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:22px;
      padding:20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }
    h1{text-align:center;margin:10px 0; font-weight: 900; letter-spacing: 1px;}
    label{font-size:12px; opacity:.7; font-weight: 700; margin-left: 5px;}
    input{
      width:100%;
      margin:6px 0 12px;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.25);
      color:#fff;
      outline: none;
      font-size:14px;
    }
    input:focus{ border-color: #0aa0ff; }
    button{
      width:100%;
      padding:14px;
      border-radius:16px;
      border:0;
      font-weight:900;
      background:linear-gradient(90deg,#0aa0ff,#2a74ff);
      color:#fff;
      cursor:pointer;
      transition: opacity 0.2s, transform .05s;
    }
    button:active{ transform: scale(0.99); }
    button:disabled{opacity:.6; cursor: not-allowed;}
    .msg{margin-top:12px;font-weight:900; text-align: center; min-height: 20px;}
    .ok{color:#22c55e}
    .bad{color:#ef4444}
    .otpBox{
      display:none;
      margin-top:16px;
      padding:14px;
      border-radius:16px;
      background:rgba(0,0,0,.2);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .row{display:flex;gap:10px}
    .row button{width:50%}
    .secondary{background:#1f2937}
    .back-link {
      display: block; text-align: center; margin-top: 15px;
      color: rgba(255,255,255,0.6); text-decoration: none; font-size: 13px;
      font-weight:800;
    }
  </style>
</head>

<body>
<div class="card">
  <h1>Register</h1>

  <label>Email</label>
  <input id="email" type="email" placeholder="Enter your email" autocomplete="email">

  <label>Phone Number</label>
  <input id="phone" type="tel" placeholder="+961XXXXXXXX" inputmode="numeric" autocomplete="tel">

  <label>Password</label>
  <input id="pass" type="password" placeholder="••••••••" autocomplete="new-password">

  <label>Confirm Password</label>
  <input id="pass2" type="password" placeholder="••••••••" autocomplete="new-password">

  <button id="btn" type="button">Create Account</button>
  <div class="msg" id="msg"></div>

  <div class="otpBox" id="otpBox">
    <label>Verification Code</label>
    <input id="otp" placeholder="123456" maxlength="6" inputmode="numeric" autocomplete="one-time-code">
    <div class="row">
      <button class="secondary" id="resend" type="button">Resend</button>
      <button id="verify" type="button">Verify</button>
    </div>
  </div>

  <a href="index.html" class="back-link">Back to Home</a>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";

/* ✅ حط هون publishable key تبعك (sb_publishable_...) */
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";

const FN_SEND  = "send-phone-otp";
const FN_CHECK = "check-phone-otp";

/* ================= INIT ================= */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

const elEmail  = document.getElementById("email");
const elPhone  = document.getElementById("phone");
const elPass   = document.getElementById("pass");
const elPass2  = document.getElementById("pass2");
const btn      = document.getElementById("btn");
const msg      = document.getElementById("msg");

const otpBox   = document.getElementById("otpBox");
const otp      = document.getElementById("otp");
const resend   = document.getElementById("resend");
const verify   = document.getElementById("verify");

let LAST_PHONE = "";

/* ================= HELPERS ================= */
function show(text, ok=false){
  msg.className = "msg " + (ok ? "ok" : "bad");
  msg.textContent = text || "";
}
function setMainLoading(on, text){
  btn.disabled = on;
  btn.textContent = on ? (text || "Please wait...") : "Create Account";
  resend.disabled = on;
  verify.disabled = on;
}
function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }

/* ✅ تثبيت +961 و 8 digits بعده */
function cleanPhone(v){
  let d = onlyDigits(v);
  if (d.startsWith("961")) d = d.slice(3);
  d = d.slice(0, 8);
  return "+961" + d;
}
function isValidLbPhone(p){
  // +961 + 8 digits => length 12
  return typeof p === "string" && p.startsWith("+961") && p.length === 12;
}

/* Phone UX */
elPhone.addEventListener("focus", () => {
  if(!elPhone.value || elPhone.value === "+") elPhone.value = "+961";
});
elPhone.addEventListener("input", () => {
  elPhone.value = cleanPhone(elPhone.value);
});

/* ================= CALL EDGE FUNCTION ================= */
/* ✅ هون السر: apikey + Authorization Bearer publishable key */
async function callFn(name, body){
  const url = `${SUPABASE_URL}/functions/v1/${name}`;

  let res;
  try{
    res = await fetch(url, {
      method: "POST",
      mode: "cors",
      headers: {
        "Content-Type": "application/json",
        "apikey": sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_,
        "Authorization": "Bearer " + SUPABASE_PUBLISHABLE_KEY,
      },
      body: JSON.stringify(body || {})
    });
  }catch(e){
    throw new Error("Failed to fetch (network/CORS).");
  }

  const text = await res.text().catch(()=> "");
  let j = {};
  try { j = text ? JSON.parse(text) : {}; } catch {}

  if(!res.ok){
    const errMsg =
      (j && (j.error || j.message)) ||
      (text || `Edge Function error (HTTP ${res.status})`);
    throw new Error(`${errMsg} (HTTP ${res.status})`);
  }

  return j;
}

/* ================= REGISTER ================= */
btn.addEventListener("click", async () => {
  show("");

  const email = String(elEmail.value || "").trim().toLowerCase();
  const phone = cleanPhone(elPhone.value);
  const pw    = String(elPass.value || "");
  const pw2   = String(elPass2.value || "");

  elPhone.value = phone; // ثبتها بالواجهة

  if(!email) return show("Enter email.");
  if(!isValidLbPhone(phone)) return show("Phone must be +961XXXXXXXX (8 digits).");
  if(pw.length < 6) return show("Password must be at least 6 characters.");
  if(pw !== pw2) return show("Passwords do not match.");

  setMainLoading(true, "Creating...");

  try{
    // 1) Signup
    const { error: signUpError } = await sb.auth.signUp({
      email,
      password: pw,
      options: { data: { phone } }
    });
    if(signUpError) throw new Error(signUpError.message || "Signup failed.");

    // 2) حاول sign-in (إذا confirm email ON ممكن يفشل — بس مش مشكلة للـ OTP functions)
    const { error: signInError } = await sb.auth.signInWithPassword({ email, password: pw });
    if(signInError){
      // ما منوقف — بس منكمّل OTP لأنه functions بتشتغل بالpublishable
    }

    // 3) Send OTP
    LAST_PHONE = phone;
    await callFn(FN_SEND, { phone });

    otpBox.style.display = "block";
    show("✅ Account created! SMS sent to " + phone, true);

  }catch(e){
    show("❌ " + (e.message || "Register failed"), false);
  }finally{
    setMainLoading(false);
  }
});

/* ================= VERIFY OTP ================= */
verify.addEventListener("click", async () => {
  show("");

  const code = String(otp.value || "").trim();
  if(!LAST_PHONE) return show("Missing phone (try register again).");
  if(code.length < 4) return show("Enter the code.");

  verify.disabled = true;
  verify.textContent = "Verifying...";

  try{
    const r = await callFn(FN_CHECK, { phone: LAST_PHONE, code });

    if(r?.success === true){
      show("✅ Phone verified! Redirecting...", true);
      setTimeout(()=> location.replace("services.html?v=" + Date.now()), 600);
    }else{
      show("❌ " + (r?.error || "Invalid or expired code"), false);
    }
  }catch(e){
    show("❌ " + (e.message || "Verify failed"), false);
  }finally{
    verify.disabled = false;
    verify.textContent = "Verify";
  }
});

/* ================= RESEND OTP ================= */
resend.addEventListener("click", async () => {
  show("");

  if(!LAST_PHONE) return show("Missing phone (try register again).");
  resend.disabled = true;
  resend.textContent = "Sending...";

  try{
    await callFn(FN_SEND, { phone: LAST_PHONE });
    show("✅ Code resent to " + LAST_PHONE, true);
  }catch(e){
    show("❌ " + (e.message || "Resend failed"), false);
  }finally{
    setTimeout(()=>{
      resend.disabled = false;
      resend.textContent = "Resend";
    }, 1200);
  }
});
</script>
</body>
</html>
