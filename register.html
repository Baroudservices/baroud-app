<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - Baroud Services</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      background:linear-gradient(180deg,#0b1424,#050a14);
      font-family:system-ui,Arial;
      color:#fff;
      padding:16px;
    }
    .card{
      width:100%;
      max-width:420px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:22px;
      padding:20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }
    h1{text-align:center;margin:10px 0; font-weight:900; letter-spacing:1px;}
    label{font-size:12px; opacity:.7; font-weight:600; margin-left:5px;}
    input{
      width:100%;
      margin:6px 0 12px;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.25);
      color:#fff;
      outline:none;
      font-size:15px;
    }
    input:focus{ border-color:#0aa0ff; }
    button{
      width:100%;
      padding:14px;
      border-radius:16px;
      border:0;
      font-weight:900;
      background:linear-gradient(90deg,#0aa0ff,#2a74ff);
      color:#fff;
      cursor:pointer;
      transition:opacity .2s;
      font-size:16px;
    }
    button:active{ transform:scale(.98); }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .msg{
      margin-top:12px;
      font-weight:800;
      text-align:center;
      min-height:20px;
      white-space:pre-wrap;
    }
    .ok{color:#22c55e}
    .bad{color:#ef4444}
    .back-link{
      display:block;
      text-align:center;
      margin-top:15px;
      color:rgba(255,255,255,.6);
      text-decoration:none;
      font-size:13px;
      font-weight:700;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Register</h1>

    <label>Email</label>
    <input id="email" type="email" placeholder="Enter your email" autocomplete="email">

    <label>Phone Number</label>
    <input id="phone" type="tel" placeholder="+961XXXXXXXX" autocomplete="tel" inputmode="tel">

    <label>Password</label>
    <input id="pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password">

    <label>Confirm Password</label>
    <input id="pass2" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password">

    <button id="btn">Create Account</button>
    <div class="msg" id="msg"></div>

    <a href="index.html" class="back-link">Back to Home</a>
  </div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";

/* ================= INIT ================= */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

const email = document.getElementById("email");
const phone = document.getElementById("phone");
const pass  = document.getElementById("pass");
const pass2 = document.getElementById("pass2");
const btn   = document.getElementById("btn");
const msg   = document.getElementById("msg");

/* ================= HELPERS ================= */
function show(text, ok=false){
  msg.className = "msg " + (ok ? "ok" : "bad");
  msg.textContent = text || "";
}

function setBtnLoading(on, text){
  btn.disabled = !!on;
  btn.textContent = on ? (text || "Please wait...") : "Create Account";
}

function cleanPhone(v){
  let digits = String(v || "").replace(/\D/g, "");
  if (digits.startsWith("961")) digits = digits.substring(3);
  return "+961" + digits.slice(0, 8); // 8 digits after 961
}

phone.addEventListener("focus", () => {
  if(!phone.value || phone.value === "+") phone.value = "+961";
});
phone.addEventListener("input", ()=> {
  phone.value = cleanPhone(phone.value);
});

async function trySignIn(email, password){
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if (error) return { ok:false, error };
  return { ok:true, data };
}

/* ================= REGISTER ================= */
btn.addEventListener("click", async ()=>{
  show("");

  const e  = String(email.value || "").trim().toLowerCase();
  const p  = String(phone.value || "").trim();
  const pw = String(pass.value || "");
  const pw2= String(pass2.value || "");

  if(!e) return show("Enter email");
  if(!p.startsWith("+961") || p.length !== 12) return show("Phone must be +961XXXXXXXX (8 digits)");
  if(pw.length < 6) return show("Password must be at least 6 characters");
  if(pw !== pw2) return show("Passwords do not match");

  setBtnLoading(true, "Creating...");

  try{
    // âœ… Signup and store phone in metadata
    const { data, error: signUpError } = await sb.auth.signUp({
      email: e,
      password: pw,
      options: {
        data: { phone: p } // <-- Ù‡ÙˆÙ† ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ù‚Ù…
      }
    });

    if(signUpError) throw signUpError;

    // âœ… Ø¥Ø°Ø§ Confirm Email ON: ØºØ§Ù„Ø¨Ø§Ù‹ Ù…Ø§ ÙÙŠ session Ù‡ÙˆÙ†
    // Ù…Ù†Ø¬Ø±Ø¨ Ù†Ø¹Ù…Ù„ sign-in Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¥Ø°Ø§ Ù…Ø³Ù…ÙˆØ­)
    const login = await trySignIn(e, pw);

    if(login.ok){
      show("âœ… Account created & logged in!", true);
      // Ø±ÙˆØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
      setTimeout(()=> location.replace("services.html?v=" + Date.now()), 400);
      return;
    }

    // âœ… Ø¥Ø°Ø§ Ù…Ø§ Ù‚Ø¯Ø± ÙŠØ¹Ù…Ù„ loginØŒ Ù…Ø¹Ù†Ø§ØªÙ‡ Ù„Ø§Ø²Ù… ØªØ£ÙƒÙŠØ¯ Ø§ÙŠÙ…ÙŠÙ„
    show("âœ… Account created!\nðŸ“§ Please confirm your email then login.", true);
    setTimeout(()=> location.replace("login.html?v=" + Date.now()), 1200);

  }catch(err){
    const m = err?.message || "Register failed";
    show(m);
  }finally{
    setBtnLoading(false);
  }
});

// Enter key support
pass2.addEventListener("keydown", (e)=>{ if(e.key === "Enter") btn.click(); });
</script>
</body>
</html>
