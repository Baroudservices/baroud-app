<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register - Baroud Services</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      background:linear-gradient(180deg,#0b1424,#050a14);
      font-family:system-ui,Arial;
      color:#fff;
      padding:16px;
    }
    .card{
      width:100%;
      max-width:420px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:22px;
      padding:20px;
      box-shadow:0 18px 70px rgba(0,0,0,.45);
    }
    h1{text-align:center;margin:10px 0 20px}
    label{font-size:13px;opacity:.8}
    input{
      width:100%;
      padding:12px;
      margin-top:6px;
      margin-bottom:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.3);
      color:#fff;
      outline:none;
      font-size:15px;
    }
    button{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:none;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(90deg,#0aa0ff,#2a74ff);
      color:#fff;
      font-size:16px;
    }
    button:disabled{opacity:.6}
    .msg{margin-top:12px;font-weight:800}
    .ok{color:#22c55e}
    .bad{color:#ef4444}

    .otpBox{
      display:none;
      margin-top:20px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,.15);
    }
  </style>
</head>

<body>
<div class="card">

  <h1>Register</h1>

  <label>Email</label>
  <input id="email" type="email" placeholder="name@email.com"/>

  <label>Phone Number</label>
  <input
    id="phone"
    type="tel"
    value="+961"
    inputmode="numeric"
  />

  <label>Password</label>
  <input id="pass" type="password"/>

  <label>Confirm Password</label>
  <input id="pass2" type="password"/>

  <button id="btn">Create Account</button>

  <div id="msg" class="msg"></div>

  <!-- OTP -->
  <div id="otpBox" class="otpBox">
    <label>Verification Code</label>
    <input id="otpCode" inputmode="numeric" placeholder="123456"/>

    <button id="verifyBtn" style="margin-top:10px">Verify Phone</button>
  </div>

</div>

<script>
/* ================== CONFIG ================== */
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_ANON_KEY = "PUT_YOUR_ANON_KEY_HERE"; // anon public key فقط

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================== ELEMENTS ================== */
const emailEl = document.getElementById("email");
const phoneEl = document.getElementById("phone");
const passEl  = document.getElementById("pass");
const pass2El = document.getElementById("pass2");
const btn     = document.getElementById("btn");
const msg     = document.getElementById("msg");

const otpBox  = document.getElementById("otpBox");
const otpCode = document.getElementById("otpCode");
const verifyBtn = document.getElementById("verifyBtn");

let CURRENT_PHONE = "";

/* ================== HELPERS ================== */
function showMsg(t, ok=false){
  msg.textContent = t;
  msg.className = "msg " + (ok ? "ok" : "bad");
}

/* ================== PHONE ENFORCE +961 ================== */
phoneEl.addEventListener("input", ()=>{
  if(!phoneEl.value.startsWith("+961")){
    phoneEl.value = "+961";
  }
});

/* ================== REGISTER ================== */
btn.onclick = async () => {
  showMsg("");

  const email = emailEl.value.trim().toLowerCase();
  const phone = phoneEl.value.trim();
  const pass  = passEl.value;
  const pass2 = pass2El.value;

  if(!email) return showMsg("Enter email");
  if(!phone.startsWith("+961") || phone.length < 7)
    return showMsg("Phone must start with +961");
  if(pass.length < 6) return showMsg("Password too short");
  if(pass !== pass2) return showMsg("Passwords do not match");

  btn.disabled = true;
  btn.textContent = "Creating...";

  const { error } = await sb.auth.signUp({
    email,
    password: pass,
    options:{
      data:{ phone }
    }
  });

  if(error){
    showMsg(error.message);
    btn.disabled = false;
    btn.textContent = "Create Account";
    return;
  }

  // login مباشرة
  const { data, error:loginErr } =
    await sb.auth.signInWithPassword({ email, password: pass });

  if(loginErr){
    showMsg("Account created. Please login.");
    return;
  }

  CURRENT_PHONE = phone;

  // send OTP
  const res = await fetch(
    SUPABASE_URL + "/functions/v1/send-phone-otp",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ phone })
    }
  );

  if(!res.ok){
    showMsg("Failed to send SMS");
    return;
  }

  showMsg("SMS sent. Enter code below.", true);
  otpBox.style.display = "block";
  btn.style.display = "none";
};

/* ================== VERIFY OTP ================== */
verifyBtn.onclick = async () => {
  const code = otpCode.value.trim();
  if(code.length < 4) return showMsg("Enter code");

  verifyBtn.disabled = true;
  verifyBtn.textContent = "Verifying...";

  const res = await fetch(
    SUPABASE_URL + "/functions/v1/check-phone-otp",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        phone: CURRENT_PHONE,
        code
      })
    }
  );

  const j = await res.json();

  if(!res.ok || j.valid !== true){
    showMsg("Invalid or expired code");
    verifyBtn.disabled = false;
    verifyBtn.textContent = "Verify Phone";
    return;
  }

  showMsg("Phone verified. Redirecting...", true);
  setTimeout(()=>{
    location.href = "services.html";
  }, 800);
};
</script>
</body>
</html>
