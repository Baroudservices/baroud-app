<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin – Plan Prices</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui,Arial;background:linear-gradient(160deg,#060b16,#0a1330);color:#fff;padding:16px}
.wrap{max-width:1100px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
.btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;background:#1e293b;color:#fff}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px;margin-bottom:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.title{font-weight:950}
.small{opacity:.75;font-size:12px}
.grid{display:grid;grid-template-columns:repeat(5,minmax(120px,1fr));gap:10px;margin-top:10px}
.box{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px}
.label{font-size:12px;opacity:.75;font-weight:900;margin-bottom:6px}
input{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  color:#fff;
  outline:none;
  font-weight:900;
}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.save{background:linear-gradient(90deg,#0aa0ff,#2a74ff);font-weight:950}
.toggle{display:flex;gap:8px;align-items:center;font-size:12px;opacity:.9;font-weight:900;margin-top:8px}
select{
  padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);color:#fff;outline:none;font-weight:900
}

/* ===== Manage Plans Modal (added) ===== */
.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center;
  padding:16px; z-index:99999;
}
.modalCard{
  width:min(720px,100%);
  background:rgba(18, 22, 34, 0.96);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.45);
  padding:14px;
}
.modalTop{display:flex;justify-content:space-between;align-items:center;gap:12px}
.modalTitle{font-weight:950;font-size:16px}
.modalX{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:#fff; border-radius:12px;
  padding:8px 10px; cursor:pointer;
}
.plansTable{width:100%;border-collapse:collapse;margin-top:12px}
.plansTable th,.plansTable td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px;font-size:13px;vertical-align:top}
.plansTable th{opacity:.85;text-align:left}
.pillBtn{
  padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);color:#fff;cursor:pointer;font-weight:900
}
.danger{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)}
.modalBtns{margin-top:12px;display:flex;gap:10px;justify-content:flex-end}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <div style="font-weight:950;font-size:20px">Admin – Plan Prices</div>
      <div class="small">Edit prices per product (no auto multiply)</div>
    </div>
    <div class="row">
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="small">Quick select product:</div>
      <select id="productSelect"></select>
      <button class="btn save" id="btnOpen">Open</button>
    </div>
  </div>

  <div id="editor"></div>
  <div id="msg" class="small"></div>
</div>

<!-- ✅ Manage Plans Modal (added) -->
<div id="plansModal" class="modal">
  <div class="modalCard">
    <div class="modalTop">
      <div class="modalTitle">Manage Plans</div>
      <button class="modalX" id="plansClose" type="button">✕</button>
    </div>

    <div class="small" style="margin-top:6px">
      Add / edit durations for this product. plan_key لازم يكون unique داخل نفس المنتج (مثلاً: 1m, 45d, vip, 2y).
    </div>

    <table class="plansTable">
      <thead>
        <tr>
          <th style="width:160px">plan_key</th>
          <th>plan_label</th>
          <th style="width:140px">price</th>
          <th style="width:110px">active</th>
          <th style="width:120px">remove</th>
        </tr>
      </thead>
      <tbody id="plansTbody"></tbody>
    </table>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="pillBtn" id="btnAddPlan" type="button">+ Add plan</button>
    </div>

    <div class="modalBtns">
      <button class="pillBtn" id="btnPlansCancel" type="button">Cancel</button>
      <button class="pillBtn" id="btnPlansSave" type="button" style="background:linear-gradient(90deg,#0aa0ff,#2a74ff);border:0">Save Plans</button>
    </div>
  </div>
</div>

<script>
// 1. المفاتيح الصحيحة (تأكد أن الـ Key هو الـ Service Role إذا كنت تريد تجاوز الـ RLS)
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_"; 
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// 2. الخطط الافتراضية
const DEFAULT_PLAN_LIST = [
  { key:"1", label:"1 month"  },
  { key:"2", label:"3 months" },
  { key:"3", label:"6 months" },
  { key:"4", label:"1 year"   },
  { key:"5", label:"2 years"  },
];

let PLAN_LIST = DEFAULT_PLAN_LIST.slice();

// الربط مع العناصر
const productSelect = document.getElementById("productSelect");
const editor = document.getElementById("editor");
const msg = document.getElementById("msg");
const btnRefresh = document.getElementById("btnRefresh");
const btnLogout = document.getElementById("btnLogout");
const btnOpen = document.getElementById("btnOpen");

// Modal Elements
const plansModal = document.getElementById("plansModal");
const plansClose = document.getElementById("plansClose");
const plansTbody = document.getElementById("plansTbody");
const btnAddPlan = document.getElementById("btnAddPlan");
const btnPlansCancel = document.getElementById("btnPlansCancel");
const btnPlansSave = document.getElementById("btnPlansSave");
let _currentPlansProductId = null;
let IS_ADMIN = false;

// دالة التنظيف (Escaping)
function esc(s){
  return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

// التحقق من الجلسة والصلاحيات
async function requireSession(){
  const { data: { session }, error } = await sb.auth.getSession();
  if(error || !session) { window.location.href="login.html"; return null; }
  return session;
}

async function requireAdmin(session){
  const { data: profile, error } = await sb.from("profiles").select("is_admin").eq("id", session.user.id).single();
  if(error || !profile?.is_admin){
    alert("عذراً، أنت لست مسؤولاً (Admin)");
    window.location.href = "services.html";
    return false;
  }
  IS_ADMIN = true;
  return true;
}

// جلب المنتجات للقائمة المنسدلة
async function loadProducts(){
  const { data, error } = await sb.from("products").select("id,title,active").order("id");
  if(error) throw error;
  productSelect.innerHTML = data.map(p => `<option value="${p.id}">#${p.id} – ${p.title} ${p.active ? '' : '(Inactive)'}</option>`).join('');
}

// جلب الخطط والأسعار لمنتج معين
async function loadPlans(productId){
  msg.textContent = "Loading...";
  _currentPlansProductId = productId;
  
  const { data: dbPlans, error } = await sb.from("product_plan_prices").select("*").eq("product_id", productId);
  if(error) { msg.textContent = "Error: " + error.message; return; }

  const map = {};
  dbPlans.forEach(r => map[r.plan_key] = r);

  // تحديث القائمة الحالية بناءً على الموجود في الداتابيز أو الافتراضي
  if(dbPlans.length > 0) {
    PLAN_LIST = dbPlans.map(x => ({ key: x.plan_key, label: x.plan_label || x.plan_key }));
  } else {
    PLAN_LIST = DEFAULT_PLAN_LIST.slice();
  }

  const title = productSelect.options[productSelect.selectedIndex]?.textContent || "Product";
  
  editor.innerHTML = `
    <div class="card">
      <div class="title">${esc(title)}</div>
      <div class="grid">
        ${PLAN_LIST.map(pl => {
          const row = map[pl.key];
          const price = row ? Number(row.price || 0) : 0;
          const active = row ? !!row.active : true;
          return `
            <div class="box">
              <div class="label">${esc(pl.label)} (${esc(pl.key)})</div>
              <input type="number" step="0.01" value="${price.toFixed(2)}" data-price="${esc(pl.key)}" />
              <label class="toggle">
                <input type="checkbox" ${active ? "checked" : ""} data-active="${esc(pl.key)}" /> Active
              </label>
            </div>`;
        }).join("")}
      </div>
      <div class="actions">
        <button class="btn" id="btnManagePlans">Manage Plans</button>
        <button class="btn save" id="btnSave">Save Prices</button>
      </div>
    </div>`;

  // إعادة ربط الأزرار بعد الـ InnerHTML
  document.getElementById("btnSave").onclick = () => savePrices(productId);
  document.getElementById("btnManagePlans").onclick = () => {
    loadPlansForManage(productId);
    plansModal.style.display = "flex";
  };
  msg.textContent = "";
}

// حفظ الأسعار السريع
async function savePrices(productId){
  if(!IS_ADMIN) return;
  msg.textContent = "Saving prices...";
  
  const rows = PLAN_LIST.map(pl => ({
    product_id: Number(productId),
    plan_key: pl.key,
    plan_label: pl.label,
    price: parseFloat(editor.querySelector(`input[data-price="${pl.key}"]`).value) || 0,
    active: editor.querySelector(`input[data-active="${pl.key}"]`).checked,
    updated_at: new Date().toISOString()
  }));

  const { error } = await sb.from("product_plan_prices").upsert(rows, { onConflict: "product_id,plan_key" });
  msg.textContent = error ? "Error: " + error.message : "Prices Saved ✅";
}

// إدارة الخطط (Add/Delete)
function renderPlanRow(row){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input data-k value="${esc(row.plan_key)}" placeholder="1m" /></td>
    <td><input data-l value="${esc(row.plan_label)}" placeholder="1 Month" /></td>
    <td><input data-p type="number" step="0.01" value="${Number(row.price||0).toFixed(2)}" /></td>
    <td style="text-align:center"><input data-a type="checkbox" ${row.active !== false ? "checked":""} /></td>
    <td><button class="pillBtn danger" type="button" onclick="this.closest('tr').remove()">Delete</button></td>`;
  plansTbody.appendChild(tr);
}

async function loadPlansForManage(productId){
  const { data, error } = await sb.from("product_plan_prices").select("*").eq("product_id", productId);
  plansTbody.innerHTML = "";
  if(data && data.length > 0) data.forEach(renderPlanRow);
  else renderPlanRow({ plan_key:"1m", plan_label:"1 Month", price:0, active:true });
}

// حفظ كل الخطط من الـ Modal
btnPlansSave.onclick = async () => {
  const trs = Array.from(plansTbody.querySelectorAll("tr"));
  const rows = trs.map(tr => ({
    product_id: _currentPlansProductId,
    plan_key: tr.querySelector("[data-k]").value.trim(),
    plan_label: tr.querySelector("[data-l]").value.trim(),
    price: parseFloat(tr.querySelector("[data-p]").value) || 0,
    active: tr.querySelector("[data-a]").checked
  })).filter(r => r.plan_key);

  const { error } = await sb.from("product_plan_prices").upsert(rows, { onConflict: "product_id,plan_key" });
  if(!error) {
    plansModal.style.display = "none";
    loadPlans(_currentProductId);
  } else {
    alert("Save Error: " + error.message);
  }
};

// إغلاق الـ Modal
const closePlansModal = () => plansModal.style.display = "none";
plansClose.onclick = closePlansModal;
btnPlansCancel.onclick = closePlansModal;

// تشغيل عند البداية
async function boot(){
  const session = await requireSession();
  if(session && await requireAdmin(session)){
    await loadProducts();
    if(productSelect.value) loadPlans(productSelect.value);
  }
}

btnOpen.onclick = () => loadPlans(productSelect.value);
btnRefresh.onclick = boot;
btnLogout.onclick = async () => { await sb.auth.signOut(); location.href="login.html"; };
btnAddPlan.onclick = () => renderPlanRow({ plan_key:"", plan_label:"", price:0, active:true });

boot();
</script>
  <script src="app-ui.js?v=3"></script>
</body>
</html>
