<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin – Plan Prices</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui,Arial;background:linear-gradient(160deg,#060b16,#0a1330);color:#fff;padding:16px}
.wrap{max-width:1100px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
.btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;background:#1e293b;color:#fff}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px;margin-bottom:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.title{font-weight:950}
.small{opacity:.75;font-size:12px}
.grid{display:grid;grid-template-columns:repeat(5,minmax(120px,1fr));gap:10px;margin-top:10px}
.box{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px}
.label{font-size:12px;opacity:.75;font-weight:900;margin-bottom:6px}
input{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  color:#fff;
  outline:none;
  font-weight:900;
}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.save{background:linear-gradient(90deg,#0aa0ff,#2a74ff);font-weight:950}
.toggle{display:flex;gap:8px;align-items:center;font-size:12px;opacity:.9;font-weight:900;margin-top:8px}
select{
  padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);color:#fff;outline:none;font-weight:900
}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div style="font-weight:950;font-size:20px">Admin – Plan Prices</div>
      <div class="small">Edit prices per product (no auto multiply)</div>
    </div>
    <div class="row">
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="small">Quick select product:</div>
      <select id="productSelect"></select>
      <button class="btn save" id="btnOpen">Open</button>
    </div>
  </div>

  <div id="editor"></div>
  <div id="msg" class="small"></div>
</div>

<script>
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const PLAN_LIST = [
  { key:"1m", label:"1 month"  },
  { key:"3m", label:"3 months" },
  { key:"6m", label:"6 months" },
  { key:"1y", label:"1 year"   },
  { key:"2y", label:"2 years"  },
];

const productSelect = document.getElementById("productSelect");
const editor = document.getElementById("editor");
const msg = document.getElementById("msg");
const btnRefresh = document.getElementById("btnRefresh");
const btnLogout = document.getElementById("btnLogout");
const btnOpen = document.getElementById("btnOpen");

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function requireSession(){
  const { data: s, error } = await sb.auth.getSession();
  if(error) throw error;
  if(!s?.session){ location.href="login.html"; return null; }
  return s.session;
}

async function requireAdmin(session){
  const { data: profile, error } = await sb
    .from("profiles")
    .select("is_admin")
    .eq("id", session.user.id)
    .single();
  if(error) throw error;
  if(!profile?.is_admin){ alert("Not admin"); return false; }
  return true;
}

async function loadProducts(){
  const { data, error } = await sb
    .from("products")
    .select("id,title,active")
    .order("id", { ascending:true });
  if(error) throw error;

  productSelect.innerHTML = "";
  for(const p of (data || [])){
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `#${p.id} – ${p.title}${p.active===false ? " (inactive)" : ""}`;
    productSelect.appendChild(opt);
  }
}

async function loadPlans(productId){
  const { data, error } = await sb
    .from("product_plan_prices")
    .select("plan_key, plan_label, price, active")
    .eq("product_id", productId);
  if(error) throw error;

  const map = {};
  for(const r of (data || [])) map[r.plan_key] = r;

  // build editor UI
  const productOpt = productSelect.options[productSelect.selectedIndex];
  const title = productOpt ? productOpt.textContent : `#${productId}`;

  editor.innerHTML = `
    <div class="card">
      <div class="title">${esc(title)}</div>
      <div class="small">Set exact prices for each plan. (No multiplication)</div>

      <div class="grid">
        ${PLAN_LIST.map(pl=>{
          const row = map[pl.key];
          const price = row ? Number(row.price || 0) : 0;
          const active = row ? !!row.active : true;
          return `
            <div class="box">
              <div class="label">${esc(pl.label)} (${esc(pl.key)})</div>
              <input type="number" step="0.01" min="0" value="${esc(price.toFixed(2))}" data-price="${esc(pl.key)}" />
              <label class="toggle">
                <input type="checkbox" ${active ? "checked" : ""} data-active="${esc(pl.key)}" />
                Active
              </label>
            </div>
          `;
        }).join("")}
      </div>

      <div class="actions">
        <button class="btn save" id="btnSave">Save</button>
      </div>
    </div>
  `;

  document.getElementById("btnSave").addEventListener("click", ()=> savePlans(productId));
}

async function savePlans(productId){
  msg.textContent = "Saving...";
  const rows = PLAN_LIST.map(pl=>{
    const priceEl = editor.querySelector(`input[data-price="${pl.key}"]`);
    const activeEl = editor.querySelector(`input[data-active="${pl.key}"]`);
    const price = Number(priceEl?.value || 0);
    const active = !!activeEl?.checked;

    return {
      product_id: Number(productId),
      plan_key: pl.key,
      plan_label: pl.label,
      price: Number.isFinite(price) ? price : 0,
      active,
      updated_at: new Date().toISOString()
    };
  });

  const { error } = await sb
    .from("product_plan_prices")
    .upsert(rows, { onConflict: "product_id,plan_key" });

  if(error){
    msg.textContent = "Error: " + (error.message || error);
    return;
  }
  msg.textContent = "Saved ✅";
}

async function boot(){
  try{
    const session = await requireSession();
    if(!session) return;

    const ok = await requireAdmin(session);
    if(!ok) return;

    await loadProducts();
    if(productSelect.value) await loadPlans(Number(productSelect.value));
  }catch(e){
    msg.textContent = "Error: " + (e?.message || e);
  }
}

btnOpen.addEventListener("click", ()=>{
  const id = Number(productSelect.value);
  if(Number.isFinite(id)) loadPlans(id);
});
btnRefresh.addEventListener("click", boot);
btnLogout.addEventListener("click", async ()=>{
  await sb.auth.signOut();
  location.href="login.html";
});

boot();
</script>
</body>
</html>
