<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin – Plan Prices</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui,Arial;background:linear-gradient(160deg,#060b16,#0a1330);color:#fff;padding:16px}
.wrap{max-width:1100px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
.btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;background:#1e293b;color:#fff}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px;margin-bottom:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.title{font-weight:950}
.small{opacity:.75;font-size:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));gap:10px;margin-top:10px}
.box{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px}
.label{font-size:12px;opacity:.75;font-weight:900;margin-bottom:6px}
input{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  color:#fff;
  outline:none;
  font-weight:900;
}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.save{background:linear-gradient(90deg,#0aa0ff,#2a74ff);font-weight:950}
.toggle{display:flex;gap:8px;align-items:center;font-size:12px;opacity:.9;font-weight:900;margin-top:8px}
select{
  padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);color:#fff;outline:none;font-weight:900
}

/* Search UI */
.searchRow{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%;
}
.searchInput{
  width:min(340px,100%);
}

/* ===== Manage Plans Modal ===== */
.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.7);
  display:none; align-items:center; justify-content:center;
  padding:16px; z-index:99999;
}
.modalCard{
  width:min(720px,100%);
  background:#0f172a;
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.45);
  padding:20px;
}
.modalTop{display:flex;justify-content:space-between;align-items:center;gap:12px}
.modalTitle{font-weight:950;font-size:16px}
.modalX{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:#fff; border-radius:12px;
  padding:8px 10px; cursor:pointer;
}
.plansTable{width:100%;border-collapse:collapse;margin-top:12px}
.plansTable th,.plansTable td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px;font-size:13px;vertical-align:top}
.plansTable th{opacity:.85;text-align:left}
.pillBtn{
  padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);color:#fff;cursor:pointer;font-weight:900
}
.danger{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35); color: #ff6b6b}
.modalBtns{margin-top:12px;display:flex;gap:10px;justify-content:flex-end}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <div style="font-weight:950;font-size:20px">Admin – Plan Prices</div>
      <div class="small">Edit prices per product (no auto multiply)</div>
    </div>
    <div class="row">
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn" id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="card">
    <div class="row searchRow">
      <div class="small">Search product:</div>
      <input id="productSearch" class="searchInput" placeholder="Type product name..." />
      <button class="btn" id="btnSearch" type="button">Search</button>
      <button class="btn" id="btnClearSearch" type="button">Clear</button>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="small">Quick select product:</div>
      <select id="productSelect"></select>
      <button class="btn save" id="btnOpen">Open</button>
    </div>
  </div>

  <div id="editor"></div>
  <div id="msg" class="small" style="margin-top: 10px; font-weight: bold;"></div>
</div>

<div id="plansModal" class="modal">
  <div class="modalCard">
    <div class="modalTop">
      <div class="modalTitle">Manage Plans</div>
      <button class="modalX" id="plansClose" type="button">✕</button>
    </div>

    <div class="small" style="margin-top:6px">
      Add / edit durations. <b>plan_key</b> must be unique (e.g., 1m, 2y, vip).
    </div>

    <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
        <table class="plansTable">
          <thead>
            <tr>
              <th style="width:160px">plan_key</th>
              <th>plan_label</th>
              <th style="width:140px">price</th>
              <th style="width:110px">active</th>
              <th style="width:120px">remove</th>
            </tr>
          </thead>
          <tbody id="plansTbody"></tbody>
        </table>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="pillBtn" id="btnAddPlan" type="button">+ Add plan</button>
    </div>

    <div class="modalBtns">
      <button class="pillBtn" id="btnPlansCancel" type="button">Cancel</button>
      <button class="pillBtn" id="btnPlansSave" type="button" style="background:linear-gradient(90deg,#0aa0ff,#2a74ff);border:0">Save Plans</button>
    </div>
  </div>
</div>

<script>
// 1. Supabase Config
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_"; 
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const DEFAULT_PLAN_LIST = [
  { key:"1", label:"1 month"  },
  { key:"2", label:"3 months" },
  { key:"3", label:"6 months" },
  { key:"4", label:"1 year"   },
];

let PLAN_LIST = [];
let _currentPlansProductId = null;
let IS_ADMIN = false;

const productSelect = document.getElementById("productSelect");
const editor = document.getElementById("editor");
const msg = document.getElementById("msg");
const plansModal = document.getElementById("plansModal");
const plansTbody = document.getElementById("plansTbody");

// ✅ NEW: search elements + products cache
const productSearch = document.getElementById("productSearch");
const btnSearch = document.getElementById("btnSearch");
const btnClearSearch = document.getElementById("btnClearSearch");
let ALL_PRODUCTS = []; // cache

function esc(s){
  return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

// Auth & Admin Check
async function boot(){
  const { data: { session } } = await sb.auth.getSession();
  if(!session) { window.location.href="login.html"; return; }
  
  const { data: profile } = await sb.from("profiles").select("is_admin").eq("id", session.user.id).single();
  if(!profile?.is_admin){
    alert("Access Denied: Admins Only");
    window.location.href = "services.html";
    return;
  }
  
  IS_ADMIN = true;
  await loadProducts();
}

function renderProductSelect(list){
  productSelect.innerHTML = list
    .map(p => `<option value="${p.id}">#${p.id} – ${esc(p.title)}</option>`)
    .join("");

  if(list.length === 0){
    productSelect.innerHTML = `<option value="">No products found</option>`;
  }
}

async function loadProducts(){
  const { data, error } = await sb.from("products").select("id,title,active").order("title");
  if(error) return;

  ALL_PRODUCTS = data || [];
  renderProductSelect(ALL_PRODUCTS);

  if(ALL_PRODUCTS.length > 0){
    loadPlans(productSelect.value);
  }
}

// ✅ NEW: search/filter function
function applySearch(){
  const q = String(productSearch.value || "").trim().toLowerCase();

  if(!q){
    renderProductSelect(ALL_PRODUCTS);
    return;
  }

  const filtered = ALL_PRODUCTS.filter(p =>
    String(p.title || "").toLowerCase().includes(q)
  );

  renderProductSelect(filtered);

  // auto select first match
  if(filtered.length > 0){
    productSelect.value = filtered[0].id;
  }
}

btnSearch.onclick = applySearch;
btnClearSearch.onclick = () => {
  productSearch.value = "";
  renderProductSelect(ALL_PRODUCTS);
  if(ALL_PRODUCTS.length > 0){
    productSelect.value = ALL_PRODUCTS[0].id;
  }
};

// live filter while typing
productSearch.addEventListener("input", () => {
  applySearch();
});

async function loadPlans(productId){
  if(!productId) return;
  msg.textContent = "Fetching plans...";
  _currentPlansProductId = productId;
  
  const { data: dbPlans, error } = await sb.from("product_plan_prices").select("*").eq("product_id", productId);
  if(error) { msg.textContent = "Error: " + error.message; return; }

  // Update Global PLAN_LIST
  PLAN_LIST = dbPlans.length > 0 
    ? dbPlans.map(x => ({ key: x.plan_key, label: x.plan_label || x.plan_key }))
    : DEFAULT_PLAN_LIST.slice();

  const map = {};
  dbPlans.forEach(r => map[r.plan_key] = r);

  const title = productSelect.options[productSelect.selectedIndex]?.textContent || "Product";
  
  editor.innerHTML = `
    <div class="card">
      <div class="title">${esc(title)}</div>
      <div class="grid" id="pricesGrid">
        ${PLAN_LIST.map(pl => {
          const row = map[pl.key];
          const price = row ? Number(row.price || 0) : 0;
          const active = row ? !!row.active : true;
          return `
            <div class="box">
              <div class="label">${esc(pl.label)}</div>
              <input type="number" step="0.01" value="${price.toFixed(2)}" data-price-key="${esc(pl.key)}" />
              <label class="toggle">
                <input type="checkbox" ${active ? "checked" : ""} data-active-key="${esc(pl.key)}" /> Active
              </label>
            </div>`;
        }).join("")}
      </div>
      <div class="actions">
        <button class="btn" id="btnManagePlans">Manage Plans Structure</button>
        <button class="btn save" id="btnSave">Quick Update Prices</button>
      </div>
    </div>`;

  document.getElementById("btnSave").onclick = () => savePrices(productId);
  document.getElementById("btnManagePlans").onclick = () => {
    loadPlansForManage(productId);
    plansModal.style.display = "flex";
  };
  msg.textContent = "Ready.";
}

async function savePrices(productId){
  if(!IS_ADMIN) return;
  msg.textContent = "Updating database...";
  
  const rows = PLAN_LIST.map(pl => ({
    product_id: Number(productId),
    plan_key: pl.key,
    plan_label: pl.label,
    price: parseFloat(editor.querySelector(`input[data-price-key="${pl.key}"]`).value) || 0,
    active: editor.querySelector(`input[data-active-key="${pl.key}"]`).checked,
    updated_at: new Date().toISOString()
  }));

  const { error } = await sb.from("product_plan_prices").upsert(rows, { onConflict: "product_id,plan_key" });
  if(error) msg.textContent = "Error: " + error.message;
  else {
      msg.textContent = "Prices Saved Successfully! ✅";
      setTimeout(() => msg.textContent = "", 2000);
  }
}

function renderPlanRow(row){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input data-k value="${esc(row.plan_key)}" placeholder="e.g. 1m" /></td>
    <td><input data-l value="${esc(row.plan_label)}" placeholder="e.g. 1 Month" /></td>
    <td><input data-p type="number" step="0.01" value="${Number(row.price||0).toFixed(2)}" /></td>
    <td style="text-align:center"><input data-a type="checkbox" ${row.active !== false ? "checked":""} /></td>
    <td><button class="pillBtn danger" type="button" onclick="this.closest('tr').remove()">Delete</button></td>`;
  plansTbody.appendChild(tr);
}

async function loadPlansForManage(productId){
  const { data } = await sb.from("product_plan_prices").select("*").eq("product_id", productId);
  plansTbody.innerHTML = "";
  if(data && data.length > 0) data.forEach(renderPlanRow);
  else renderPlanRow({ plan_key:"", plan_label:"", price:0, active:true });
}

document.getElementById("btnPlansSave").onclick = async () => {
  const trs = Array.from(plansTbody.querySelectorAll("tr"));
  const rows = trs.map(tr => ({
    product_id: Number(_currentPlansProductId),
    plan_key: tr.querySelector("[data-k]").value.trim(),
    plan_label: tr.querySelector("[data-l]").value.trim(),
    price: parseFloat(tr.querySelector("[data-p]").value) || 0,
    active: tr.querySelector("[data-a]").checked
  })).filter(r => r.plan_key);

  if(rows.length === 0) { alert("Please add at least one plan"); return; }

  const { error } = await sb.from("product_plan_prices").upsert(rows, { onConflict: "product_id,plan_key" });
  if(!error) {
    plansModal.style.display = "none";
    loadPlans(_currentPlansProductId);
  } else {
    alert("Error: " + error.message);
  }
};

document.getElementById("btnOpen").onclick = () => loadPlans(productSelect.value);
document.getElementById("btnRefresh").onclick = () => location.reload();
document.getElementById("btnLogout").onclick = async () => { await sb.auth.signOut(); location.href="login.html"; };
document.getElementById("btnAddPlan").onclick = () => renderPlanRow({ plan_key:"", plan_label:"", price:0, active:true });
document.getElementById("plansClose").onclick = () => plansModal.style.display = "none";
document.getElementById("btnPlansCancel").onclick = () => plansModal.style.display = "none";

boot();
</script>
</body>
</html>
