<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phone Recharge - Baroud</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; padding:0;}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:#020b14;
      color:#fff;
      min-height:100vh;
      overflow-x:hidden;
      padding-bottom: 20px;
    }
    .wrap{ width: 100%; margin: 0 auto; padding: 14px; max-width: 520px; }

    /* ===== TOPBAR ===== */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 0; margin-bottom: 12px;
    }
    .topbar-left{ display:flex; align-items:center; gap:12px; }
    .menu-trigger{
      width: 45px; height: 45px; background: rgba(255,255,255,0.06);
      border-radius: 12px; display:flex; align-items:center; justify-content:center;
      font-size: 22px; cursor: pointer;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .wallet-pill{
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,0.05);
      padding: 6px 14px; border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .star-icon{ color:#ffd700; font-size:18px; }
    .balance-text{ font-weight:800; font-size:15px; }
    .add-fund-btn{
      width: 28px; height: 28px; background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      border-radius: 50%; display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:18px; font-weight:bold; cursor:pointer;
      box-shadow: 0 0 10px rgba(0, 210, 255, 0.5);
      border:none; margin-left: 5px;
    }
    .brand-title{ font-weight: 900; letter-spacing: 1.5px; font-size: 18px; text-transform: uppercase; }

    /* ===== HEADER CARD ===== */
    .page-head{
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 14px;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .page-head h1{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .back-btn{
      width: 42px; height: 42px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      color:#fff;
      cursor:pointer;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* ===== FILTER BAR ===== */
    .filters{
      display:flex;
      gap:10px;
      margin-bottom: 12px;
      overflow-x:auto;
      padding-bottom: 2px;
    }
    .filters::-webkit-scrollbar{ height: 0; }
    .fbtn{
      flex: 0 0 auto;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color:#fff;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .fbtn.active{
      background: linear-gradient(135deg, rgba(0,210,255,.35), rgba(58,123,213,.35));
      border-color: rgba(0,210,255,.35);
      box-shadow: 0 0 18px rgba(0,210,255,.15);
    }

    /* ===== SEARCH ===== */
    .search-box{
      background: rgba(255,255,255,0.05);
      border-radius: 25px;
      padding: 14px 20px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .search-box input{
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: #fff;
      font-size: 15px;
    }

    /* ===== GRID PRODUCTS ===== */
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card{
      background: #0b141d;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.05);
      cursor: pointer;
      transition: .2s;
      text-decoration:none;
      color:inherit;
    }
    .card:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,0.10); }
    .imgBox{
      width:100%;
      height: 110px;
      background: rgba(255,255,255,0.04);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .imgBox img{ width: 100%; height: 100%; object-fit: cover; display:block; }
    .cardBody{ padding: 10px 12px; }
    .title{
      font-weight: 950;
      font-size: 13px;
      line-height: 1.2;
      margin-bottom: 6px;
      min-height: 32px;
    }
    .meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      opacity: .95;
    }
    .pill{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      opacity: .9;
      max-width: 70%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .price{
      font-weight: 950;
      color: #38bdf8;
      font-size: 12px;
      white-space: nowrap;
    }

    /* ===== EMPTY / ERROR ===== */
    .msg{
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.05);
      opacity: .95;
    }

    /* ===== DRAWER (SIDEBAR) ===== */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.8); opacity:0; pointer-events:none; transition:0.3s; z-index:2000; }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .drawer{
      position:fixed; top:0; left:0; width:290px; height:100vh;
      background:#06162a; border-right:1px solid rgba(255,255,255,.1);
      transform:translateX(-100%); transition:0.3s; z-index:2100; padding:25px;
      display:flex; flex-direction:column;
    }
    .drawer.show{ transform:translateX(0); }
    .m-item{ display:flex; align-items:center; gap:15px; padding:14px; border-radius:12px; cursor:pointer; text-decoration:none; color:inherit; }
    .m-item:hover{ background: rgba(255,255,255,0.05); }
    .m-dot{ width:8px; height:8px; border-radius:50%; background:#00d2ff; box-shadow: 0 0 8px #00d2ff; }

    .logout-item{
      border-top: 1px solid rgba(255,255,255,0.05);
      padding-top: 15px;
      color: #ff4d4d;
      margin-top: 10px;
    }
    .logout-dot{ background:#ff4d4d; box-shadow:0 0 8px #ff4d4d; }

    .drawerTop{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px; }
    .drawerClose{
      width: 36px; height: 36px; border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      color:#fff; font-size: 18px; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
    }
    .waDot{ background:#25D366 !important; box-shadow:0 0 8px #25D366 !important; }
  </style>
</head>

<body>
  <div class="overlay" id="overlay"></div>

  <aside class="drawer" id="drawer">
    <div class="drawerTop">
      <div style="font-weight: 950; opacity:.85;">Menu</div>
      <button class="drawerClose" id="drawerClose" aria-label="Close">‚úï</button>
    </div>

    <div style="text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 20px;">
      <div style="width:60px; height:60px; background:rgba(255,255,255,0.05); border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; border:2px solid #00d2ff; font-size:25px;">üë§</div>
      <div style="font-weight: 900;">Houssein Baroud</div>
    </div>

    <div class="m-item" id="homeExit"><div class="m-dot"></div><span>Home</span></div>

    <!-- account -> profile later -->
    <a href="profile.html" class="m-item"><div class="m-dot"></div><span>Account</span></a>
    <a href="add-credit.html" class="m-item"><div class="m-dot"></div><span>Add Credit</span></a>
    <a href="my-payments.html" class="m-item"><div class="m-dot"></div><span>My Payments</span></a>
    <a href="my-orders.html" class="m-item"><div class="m-dot"></div><span>My Orders</span></a>
    <a href="security.html" class="m-item"><div class="m-dot"></div><span>Security</span></a>
    <a href="help.html" class="m-item"><div class="m-dot"></div><span>Help</span></a>

    <!-- WhatsApp in sidebar footer -->
    <a class="m-item" style="margin-top:auto;"
       href="https://wa.me/96170385398?text=Hello%20Houssein%20I%20need%20Help"
       target="_blank" rel="noopener noreferrer">
      <div class="m-dot waDot"></div><span>WhatsApp Support</span>
    </a>

    <a href="login.html" class="m-item logout-item"><div class="m-dot logout-dot"></div><span>Logout</span></a>
  </aside>

  <main class="wrap">
    <div class="topbar">
      <div class="topbar-left">
        <div class="menu-trigger" id="menuBtn">‚ò∞</div>
        <div class="wallet-pill">
          <span class="star-icon">‚òÖ</span>
          <span class="balance-text" id="balanceText">0.00 üá±üáß</span>
          <button class="add-fund-btn" onclick="location.href='add-credit.html'">+</button>
        </div>
      </div>
      <div class="brand-title">BAROUD</div>
    </div>

    <div class="page-head">
      <button class="back-btn" id="backBtn" aria-label="Back">‚Üê</button>
      <h1>üì± Phone Recharge</h1>
      <div style="width:42px;height:42px;"></div>
    </div>

    <div class="filters" id="filters">
      <div class="fbtn active" data-mode="ALFA">ALFA</div>
      <div class="fbtn" data-mode="TOUCH">TOUCH</div>
      <div class="fbtn" data-mode="CREDIT_TRANSFER">Credit Transfer</div>
    </div>

    <div class="search-box">
      <input id="q" type="text" placeholder="Search in phone recharge..." />
    </div>

    <div id="msg" class="msg" style="display:none;"></div>

    <section class="grid" id="grid"></section>
  </main>

  <script>
    // ===== Drawer =====
    const drawer = document.getElementById("drawer");
    const overlay = document.getElementById("overlay");
    const menuBtn = document.getElementById("menuBtn");
    const homeExit = document.getElementById("homeExit");
    const drawerClose = document.getElementById("drawerClose");

    menuBtn.onclick = () => { drawer.classList.add("show"); overlay.classList.add("show"); }
    const closeSidebar = () => { drawer.classList.remove("show"); overlay.classList.remove("show"); }
    overlay.onclick = closeSidebar;
    homeExit.onclick = closeSidebar;
    drawerClose.onclick = closeSidebar;

    // back
    document.getElementById("backBtn").onclick = () => {
      if (history.length > 1) history.back();
      else location.href = "services.html";
    };

    // ===== Supabase =====
    const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
    const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function esc(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    // ===== Balance =====
    async function loadBalance() {
      const el = document.getElementById("balanceText");
      if (!el) return;

      try {
        const { data: { session } } = await sb.auth.getSession();
        if (!session) { el.textContent = "0.00 üá±üáß"; return; }

        const { data, error } = await sb
          .from("profiles")
          .select("balance")
          .eq("id", session.user.id)
          .single();

        if (error) { el.textContent = "0.00 üá±üáß"; return; }
        const b = Number(data?.balance || 0);
        el.textContent = `${b.toFixed(2)} üá±üáß`;
      } catch {
        el.textContent = "0.00 üá±üáß";
      }
    }
    loadBalance();

    // ===== Products =====
    const grid = document.getElementById("grid");
    const msg = document.getElementById("msg");
    const qInput = document.getElementById("q");
    const filters = document.getElementById("filters");

    let mode = "ALFA"; // default
    let tmr = null;

    function setMsg(text){
      if(!text){
        msg.style.display = "none";
        msg.textContent = "";
        return;
      }
      msg.style.display = "block";
      msg.textContent = text;
    }

    function productImgUrl(id){
      // ŸÜŸÅÿ≥ ŸÅŸÉÿ±ÿ™ŸÉ ÿ®ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ™ÿßŸÜŸäÿ© (ÿßÿ∞ÿß ÿπŸÜÿØŸÉ ÿµŸàÿ± ŸÑŸÉŸÑ ŸÖŸÜÿ™ÿ¨)
      return `assets/products/${id}.jpg`;
    }

    function render(items){
      if(!items || items.length === 0){
        grid.innerHTML = "";
        setMsg("No products found.");
        return;
      }
      setMsg("");

      grid.innerHTML = items.map(p=>{
        const pr = Number(p.min_price || 0);
        const priceTxt = pr ? "$" + pr.toFixed(2) : "";
        return `
          <a class="card" data-id="${esc(p.id)}" href="account.html?id=${encodeURIComponent(p.id)}">
            <div class="imgBox">
              <img src="${esc(productImgUrl(p.id))}" alt="${esc(p.title)}"
                   onerror="this.onerror=null; this.src='assets/products/default.jpg';" />
            </div>
            <div class="cardBody">
              <div class="title">${esc(p.title)}</div>
              <div class="meta">
                <div class="pill">${esc(p.category || "")}</div>
                <div class="price">${esc(priceTxt)}</div>
              </div>
            </div>
          </a>
        `;
      }).join("");
    }

    function modeToKeyword(m){
      if(m === "ALFA") return "ALFA";
      if(m === "TOUCH") return "TOUCH";
      return "Credit"; // Credit Transfer keyword
    }

    async function loadProducts(){
      const queryText = (qInput.value || "").trim();
      const keyword = modeToKeyword(mode);

      setMsg("Loading...");

      let req = sb
        .from("products_with_min_price")
        .select("id,title,category,min_price")
        .eq("active", true)
        .eq("category", "Phone recharge")
        .ilike("title", `%${keyword}%`)
        .limit(60);

      if(queryText.length >= 2){
        req = req.ilike("title", `%${queryText}%`);
      }

      const { data, error } = await req;

      if(error){
        grid.innerHTML = "";
        setMsg("Error: " + error.message);
        return;
      }

      render(data || []);
    }

    // filters click
    filters.addEventListener("click", (e)=>{
      const btn = e.target.closest(".fbtn");
      if(!btn) return;
      mode = btn.getAttribute("data-mode") || "ALFA";
      Array.from(filters.querySelectorAll(".fbtn")).forEach(b=> b.classList.remove("active"));
      btn.classList.add("active");
      loadProducts();
    });

    // search input
    qInput.addEventListener("input", ()=>{
      clearTimeout(tmr);
      tmr = setTimeout(loadProducts, 250);
    });

    // initial load
    loadProducts();
  </script>

  <script src="app-ui.js?v=3"></script>
</body>
</html>
