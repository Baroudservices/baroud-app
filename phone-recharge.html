<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phone Recharge - Baroud</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; padding:0;}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:#020b14;
      color:#fff;
      min-height:100vh;
      overflow-x:hidden;
      padding-bottom: 24px;
    }
    .wrap{ width: 100%; margin: 0 auto; padding: 14px; max-width: 520px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 0; margin-bottom: 12px;
    }
    .topbar-left{ display:flex; align-items:center; gap:12px; }

    .back-btn{
      width:45px; height:45px;
      background: rgba(255,255,255,0.06);
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      font-size: 22px; cursor: pointer;
      border: 1px solid rgba(255,255,255,0.1);
      user-select:none;
    }

    .wallet-pill{
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,0.05);
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .star-icon{ color:#ffd700; font-size:18px; }
    .balance-text{ font-weight: 900; font-size: 15px; }

    .brand-title{
      font-weight: 900;
      letter-spacing: 1.2px;
      font-size: 18px;
      text-transform: uppercase;
      opacity: .95;
    }

    .hero{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 14px;
      margin-bottom: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .hero h1{ margin:0; font-size: 18px; letter-spacing: .4px; }
    .hero small{ opacity:.65; font-weight:800; }

    .search-box{
      background: rgba(255,255,255,0.05);
      border-radius: 25px;
      padding: 14px 20px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .search-box input{
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: #fff;
      font-size: 15px;
    }

    .filters{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom: 2px;
      margin-bottom: 10px;
      scrollbar-width: none;
    }
    .filters::-webkit-scrollbar{ display:none; }

    .fbtn{
      flex: 0 0 auto;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      font-weight: 950;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      opacity:.9;
      transition:.2s;
      white-space:nowrap;
    }
    .fbtn.active{
      background: linear-gradient(135deg, rgba(0,210,255,.25), rgba(58,123,213,.18));
      border-color: rgba(0,210,255,.45);
      box-shadow: 0 0 18px rgba(0,210,255,.12);
      opacity:1;
    }

    /* LIST (stacked) */
    .list{
      display:flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }
    .item{
      background: #0b141d;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .left{
      display:flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }
    .title{
      font-weight: 950;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta{
      font-size: 12px;
      opacity: .65;
      font-weight: 800;
    }
    .right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }
    .price{
      font-weight: 950;
      color:#38bdf8;
      font-size: 14px;
      white-space: nowrap;
    }
    .buy{
      border: none;
      outline: none;
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 950;
      color:#fff;
      background: linear-gradient(135deg, rgba(0,210,255,.55), rgba(58,123,213,.45));
      border: 1px solid rgba(0,210,255,.35);
      box-shadow: 0 0 18px rgba(0,210,255,.10);
    }
    .buy:active{ transform: translateY(1px); }

    .msg{
      opacity:.75;
      font-weight:900;
      padding: 12px 4px;
      text-align:center;
    }

    /* Credit Transfer box */
    .ctBox{
      margin-top: 8px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 14px;
    }
    .ctTitle{
      font-weight: 950;
      font-size: 16px;
      margin-bottom: 10px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top: 10px;
    }
    .inp{
      flex:1;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 12px 12px;
      color:#fff;
      outline:none;
      font-size: 14px;
      font-weight: 850;
    }
    .ctTotal{
      margin-top: 10px;
      font-weight: 950;
      color:#38bdf8;
      font-size: 16px;
    }
    .ctHint{
      margin-top: 6px;
      font-size: 12px;
      opacity:.65;
      font-weight: 850;
    }
    .ctBuy{
      margin-top: 12px;
      width: 100%;
      padding: 12px 14px;
      border-radius: 16px;
      border:none;
      cursor:pointer;
      font-weight: 950;
      color:#fff;
      background: linear-gradient(135deg, rgba(0,210,255,.55), rgba(58,123,213,.45));
      border: 1px solid rgba(0,210,255,.35);
      box-shadow: 0 0 18px rgba(0,210,255,.10);
    }

    /* Modal (phone / confirm) */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      padding: 18px;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: 100%;
      max-width: 520px;
      background: #071423;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    .mTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .mTitle{ font-weight: 950; font-size: 16px; }
    .mClose{
      width: 36px; height: 36px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color:#fff;
      cursor:pointer;
      font-size: 18px;
    }
    .mText{
      font-size: 13px;
      opacity:.75;
      font-weight: 800;
      margin-bottom: 10px;
      line-height: 1.35;
    }
    .mActions{
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }
    .btnGhost{
      flex:1;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      color:#fff;
      font-weight: 950;
      cursor:pointer;
    }
    .btnPrimary{
      flex:1;
      padding: 12px 14px;
      border-radius: 14px;
      border:none;
      cursor:pointer;
      font-weight: 950;
      color:#fff;
      background: linear-gradient(135deg, rgba(0,210,255,.55), rgba(58,123,213,.45));
      border: 1px solid rgba(0,210,255,.35);
      box-shadow: 0 0 18px rgba(0,210,255,.10);
    }
  </style>
</head>

<body>
  <!-- Modal -->
  <div class="overlay" id="ovl">
    <div class="modal">
      <div class="mTop">
        <div class="mTitle" id="mTitle">Buy</div>
        <button class="mClose" id="mClose">‚úï</button>
      </div>
      <div class="mText" id="mText"></div>

      <input class="inp" id="mPhone" type="tel" placeholder="Phone number (required)" style="display:none;" />

      <div class="mActions">
        <button class="btnGhost" id="mCancel">Cancel</button>
        <button class="btnPrimary" id="mOk">Confirm</button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <div class="topbar">
      <div class="topbar-left">
        <div class="back-btn" id="backBtn">‚Üê</div>
        <div class="wallet-pill">
          <span class="star-icon">‚òÖ</span>
          <span class="balance-text" id="balanceText">0.00 üá±üáß</span>
        </div>
      </div>
      <div class="brand-title">BAROUD</div>
    </div>

    <div class="hero">
      <div>
        <h1>Phone Recharge</h1>
        <small>ALFA ‚Ä¢ MTC ‚Ä¢ Credit Transfer</small>
      </div>
      <div style="opacity:.9; font-weight:950;">üì±</div>
    </div>

    <div class="search-box" id="searchWrap">
      <input id="qInput" type="text" placeholder="Search products..." />
    </div>

    <!-- Main Tabs -->
    <div class="filters" id="filters">
      <div class="fbtn active" data-mode="ALFA">ALFA</div>
      <div class="fbtn" data-mode="MTC">MTC</div>
      <div class="fbtn" data-mode="CREDIT_TRANSFER">Credit Transfer</div>
    </div>

    <!-- ALFA sub options -->
    <div class="filters" id="alfaSub" style="margin-top:-6px;">
      <div class="fbtn active" data-alfa="CARDS">Cards</div>
      <div class="fbtn" data-alfa="USHARE">uShare</div>
      <div class="fbtn" data-alfa="INTERNET">Internet</div>
    </div>

    <!-- Credit Transfer sub options -->
    <div class="filters" id="ctSub" style="display:none; margin-top:-6px;">
      <div class="fbtn active" data-ct="CREDIT_ALFA">Credit ALFA</div>
      <div class="fbtn" data-ct="CREDIT_MTC">Credit MTC</div>
    </div>

    <div class="msg" id="msg"></div>

    <!-- credit transfer UI -->
    <div class="ctBox" id="ctBox" style="display:none;">
      <div class="ctTitle">Credit Transfer</div>

      <div class="row">
        <input class="inp" id="ctPhone" type="tel" placeholder="Phone number (required)" />
      </div>

      <div class="row">
        <input class="inp" id="ctAmount" type="number" inputmode="decimal" min="0" step="0.01" placeholder="Enter amount in $" />
      </div>

      <div class="ctTotal" id="ctTotal">$0.00</div>
      <div class="ctHint" id="ctHint">Total will be calculated automatically.</div>

      <button class="ctBuy" id="ctBuyBtn">Buy</button>
    </div>

    <!-- Products list -->
    <div class="list" id="list"></div>
  </main>

  <script>
    const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
    const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const listEl = document.getElementById("list");
    const msg = document.getElementById("msg");
    const qInput = document.getElementById("qInput");
    const filters = document.getElementById("filters");
    const alfaSub = document.getElementById("alfaSub");
    const ctSub = document.getElementById("ctSub");
    const ctBox = document.getElementById("ctBox");
    const searchWrap = document.getElementById("searchWrap");

    // modal
    const ovl = document.getElementById("ovl");
    const mTitle = document.getElementById("mTitle");
    const mText = document.getElementById("mText");
    const mPhone = document.getElementById("mPhone");
    const mClose = document.getElementById("mClose");
    const mCancel = document.getElementById("mCancel");
    const mOk = document.getElementById("mOk");

    // credit transfer
    const ctPhone = document.getElementById("ctPhone");
    const ctAmount = document.getElementById("ctAmount");
    const ctTotal = document.getElementById("ctTotal");
    const ctHint = document.getElementById("ctHint");
    const ctBuyBtn = document.getElementById("ctBuyBtn");

    function esc(s){ return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function setMsg(t){ msg.textContent = t || ""; }

    document.getElementById("backBtn").onclick = () => {
      if (history.length > 1) history.back();
      else location.href = "services.html";
    };

    async function loadBalance() {
      const el = document.getElementById("balanceText");
      if (!el) return;

      try {
        const { data: { session } } = await sb.auth.getSession();
        if (!session) { el.textContent = "0.00 üá±üáß"; return; }

        const { data, error } = await sb
          .from("profiles")
          .select("balance")
          .eq("id", session.user.id)
          .single();

        if (error) { el.textContent = "0.00 üá±üáß"; return; }

        const b = Number(data?.balance || 0);
        el.textContent = `${b.toFixed(2)} üá±üáß`;
      } catch {
        el.textContent = "0.00 üá±üáß";
      }
    }
    loadBalance();

    // ===== State =====
    let mode = "ALFA";            // ALFA | MTC | CREDIT_TRANSFER
    let alfaMode = "CARDS";       // CARDS | USHARE | INTERNET
    let ctMode = "CREDIT_ALFA";   // CREDIT_ALFA | CREDIT_MTC
    let tmr = null;

    // multiplier hidden from user
    const CT_MULT = {
      CREDIT_ALFA: 1.30,
      CREDIT_MTC: 1.25
    };

    // credit transfer product id (single product)
    let creditTransferProductId = null;

    function showRightSubFilters(){
      if(mode === "ALFA"){
        alfaSub.style.display = "flex";
        ctSub.style.display = "none";
        ctBox.style.display = "none";
        searchWrap.style.display = "";
        listEl.style.display = "";
      }else if(mode === "CREDIT_TRANSFER"){
        alfaSub.style.display = "none";
        ctSub.style.display = "flex";
        ctBox.style.display = "block";
        // hide list/search in credit transfer mode
        searchWrap.style.display = "none";
        listEl.style.display = "none";
        setMsg("");
      }else{
        alfaSub.style.display = "none";
        ctSub.style.display = "none";
        ctBox.style.display = "none";
        searchWrap.style.display = "";
        listEl.style.display = "";
      }
    }

    function baseKeyword(){
      if(mode === "ALFA") return "alfa";
      if(mode === "MTC") return "mtc";
      return (ctMode === "CREDIT_ALFA") ? "alfa" : "mtc";
    }

    function extraFilters(){
      const f = [];

      if(mode === "ALFA"){
        if(alfaMode === "CARDS"){
          f.push({type:"ilike", col:"title", val:"%$%"});
          f.push({type:"not_ilike", col:"title", val:"%kl 1$%"});
          f.push({type:"not_ilike", col:"title", val:"%gb%"});
        }else if(alfaMode === "USHARE"){
          f.push({type:"ilike", col:"title", val:"%gb%"});
          f.push({type:"not_ilike", col:"title", val:"%kl 1$%"});
        }else{
          f.push({type:"ilike", col:"title", val:"%internet%"});
        }
      }

      if(mode === "MTC"){
        f.push({type:"ilike", col:"title", val:"%$%"});
        f.push({type:"not_ilike", col:"title", val:"%kl 1$%"});
        f.push({type:"not_ilike", col:"title", val:"%gb%"});
      }

      return f;
    }

    function requiresPhoneForProducts(){
      // only uShare requires phone
      return (mode === "ALFA" && alfaMode === "USHARE");
    }

    // ===== Modal helpers =====
    let modalResolve = null;

    function openModal({title, text, needPhone}){
      mTitle.textContent = title || "Confirm";
      mText.textContent = text || "";
      mPhone.value = "";
      mPhone.style.display = needPhone ? "block" : "none";
      mPhone.placeholder = needPhone ? "Phone number (required)" : "";

      ovl.classList.add("show");

      return new Promise((resolve)=>{
        modalResolve = resolve;
      });
    }

    function closeModal(result){
      ovl.classList.remove("show");
      if(modalResolve){
        modalResolve(result);
        modalResolve = null;
      }
    }

    mClose.onclick = ()=> closeModal({ok:false});
    mCancel.onclick = ()=> closeModal({ok:false});
    ovl.addEventListener("click", (e)=>{
      if(e.target === ovl) closeModal({ok:false});
    });

    mOk.onclick = ()=>{
      if(mPhone.style.display !== "none"){
        const ph = (mPhone.value || "").trim();
        if(!ph){
          alert("Phone number is required.");
          return;
        }
        closeModal({ok:true, phone: ph});
        return;
      }
      closeModal({ok:true});
    };

    // ===== RPC order (deduct + insert) =====
    async function createOrderAndCharge({product_id, price, note, phone}){
      const { data, error } = await sb.rpc("create_order_and_charge", {
        p_product_id: product_id,
        p_price: price,
        p_note: note || null,
        p_player_id: phone || null
      });

      if(error){
        alert("Order error: " + error.message);
        return null;
      }

      alert("‚úÖ Order created #" + data);
      await loadBalance();
      return data;
    }

    // ===== Render list (stacked) =====
    function render(list){
      listEl.innerHTML = "";

      if(!list || list.length === 0){
        setMsg("No products found.");
        return;
      }
      setMsg("");

      listEl.innerHTML = list.map(p=>{
        const pr = Number(p.min_price || 0);
        return `
          <div class="item" data-id="${esc(p.id)}">
            <div class="left">
              <div class="title">${esc(p.title)}</div>
              <div class="meta">${esc(p.category || "")}</div>
            </div>
            <div class="right">
              <div class="price">${pr ? "$"+pr.toFixed(2) : ""}</div>
              <button class="buy" data-buy="${esc(p.id)}">Buy</button>
            </div>
          </div>
        `;
      }).join("");

      Array.from(listEl.querySelectorAll("[data-buy]")).forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute("data-buy");
          const p = list.find(x => String(x.id) === String(id));
          if(!p) return;

          const pr = Number(p.min_price || 0);
          if(!pr || pr <= 0){
            alert("Invalid price.");
            return;
          }

          const needPhone = requiresPhoneForProducts();
          let phone = null;

          const conf = await openModal({
            title: "Confirm purchase",
            text: `Buy "${p.title}" for $${pr.toFixed(2)} ?`,
            needPhone
          });

          if(!conf.ok) return;
          if(needPhone) phone = (conf.phone || "").trim();

          const note = `${p.title}${phone ? " | Phone: "+phone : ""}`;

          await createOrderAndCharge({
            product_id: Number(p.id),
            price: pr,
            note,
            phone
          });
        };
      });
    }

    // ===== Load products for ALFA/MTC =====
    async function loadProducts(){
      const q = (qInput.value || "").trim().toLowerCase();
      setMsg("Loading...");
      listEl.innerHTML = "";

      let req = sb
        .from("products_with_min_price")
        .select("id,title,category,min_price")
        .eq("active", true)
        .eq("category", "Phone recharge")
        .ilike("title", `%${baseKeyword()}%`)
        .limit(200);

      for(const f of extraFilters()){
        if(f.type === "ilike") req = req.ilike(f.col, f.val);
        if(f.type === "not_ilike") req = req.not(f.col, "ilike", f.val);
      }

      if(q.length >= 2){
        req = req.ilike("title", `%${q}%`);
      }

      const { data, error } = await req;
      if(error){
        setMsg("Error: " + error.message);
        return;
      }

      if(mode === "ALFA" && alfaMode === "INTERNET"){
        render(data || []);
        if(!data || data.length === 0){
          setMsg("No Internet products yet.");
        }
        return;
      }

      render(data || []);
    }

    // ===== Credit Transfer setup =====
    async function loadCreditTransferProductId(){
      // one product in DB (any title contains "credit transfer")
      const { data, error } = await sb
        .from("products")
        .select("id,title,category,active")
        .eq("active", true)
        .eq("category", "Phone recharge")
        .ilike("title", "%credit transfer%")
        .limit(1);

      if(error){
        // silent
        creditTransferProductId = null;
        return;
      }

      creditTransferProductId = data?.[0]?.id ?? null;
    }

    function updateCTTotal(){
      const amt = Number(ctAmount.value || 0);
      const mult = CT_MULT[ctMode] || 1;
      const total = (amt > 0) ? (amt * mult) : 0;
      ctTotal.textContent = `$${total.toFixed(2)}`;

      // hint without showing multiplier explicitly
      const label = (ctMode === "CREDIT_ALFA") ? "ALFA" : "MTC";
      ctHint.textContent = total > 0
        ? `${label} credit transfer total calculated.`
        : "Total will be calculated automatically.";
    }

    ctAmount.addEventListener("input", updateCTTotal);

    ctBuyBtn.onclick = async ()=>{
      const phone = (ctPhone.value || "").trim();
      if(!phone){
        alert("Phone number is required.");
        return;
      }

      const amt = Number(ctAmount.value || 0);
      if(!(amt > 0)){
        alert("Enter a valid amount.");
        return;
      }

      if(!creditTransferProductId){
        alert('Credit Transfer product not found in DB. Create a product titled "Credit Transfer" in category "Phone recharge".');
        return;
      }

      const mult = CT_MULT[ctMode] || 1;
      const total = amt * mult;
      const label = (ctMode === "CREDIT_ALFA") ? "ALFA" : "MTC";

      const ok = await openModal({
        title: "Confirm Credit Transfer",
        text: `Buy Credit Transfer (${label}) for $${total.toFixed(2)} ?`,
        needPhone: false
      });

      if(!ok.ok) return;

      const note = `Credit Transfer | ${label} | Amount: $${amt.toFixed(2)} | Total: $${total.toFixed(2)} | Phone: ${phone}`;

      const created = await createOrderAndCharge({
        product_id: Number(creditTransferProductId),
        price: Number(total.toFixed(2)),
        note,
        phone
      });

      if(created){
        ctAmount.value = "";
        updateCTTotal();
      }
    };

    // ===== UI events =====
    filters.addEventListener("click", (e)=>{
      const btn = e.target.closest(".fbtn");
      if(!btn) return;
      const m = btn.getAttribute("data-mode");
      if(!m) return;

      mode = m;

      Array.from(filters.querySelectorAll(".fbtn")).forEach(b=> b.classList.remove("active"));
      btn.classList.add("active");

      if(mode === "ALFA"){
        alfaMode = "CARDS";
        Array.from(alfaSub.querySelectorAll(".fbtn")).forEach(b=> b.classList.remove("active"));
        alfaSub.querySelector('[data-alfa="CARDS"]').classList.add("active");
      }

      if(mode === "CREDIT_TRANSFER"){
        ctMode = "CREDIT_ALFA";
        Array.from(ctSub.querySelectorAll(".fbtn")).forEach(b=> b.classList.remove("active"));
        ctSub.querySelector('[data-ct="CREDIT_ALFA"]').classList.add("active");

        // reset CT UI
        ctPhone.value = "";
        ctAmount.value = "";
        updateCTTotal();
      }

      showRightSubFilters();

      if(mode === "CREDIT_TRANSFER"){
        setMsg("");
        return;
      }

      loadProducts();
    });

    alfaSub.addEventListener("click", (e)=>{
      const btn = e.target.closest(".fbtn");
      if(!btn) return;
      const a = btn.getAttribute("data-alfa");
      if(!a) return;

      alfaMode = a;

      Array.from(alfaSub.querySelectorAll(".fbtn")).forEach(b=> b.classList.remove("active"));
      btn.classList.add("active");

      loadProducts();
    });

    ctSub.addEventListener("click", (e)=>{
      const btn = e.target.closest(".fbtn");
      if(!btn) return;
      const c = btn.getAttribute("data-ct");
      if(!c) return;

      ctMode = c;

      Array.from(ctSub.querySelectorAll(".fbtn")).forEach(b=> b.classList.remove("active"));
      btn.classList.add("active");

      // update total
      updateCTTotal();
    });

    qInput.addEventListener("input", ()=>{
      clearTimeout(tmr);
      tmr = setTimeout(loadProducts, 250);
    });

    // init
    showRightSubFilters();
    loadProducts();
    loadCreditTransferProductId();
    updateCTTotal();
  </script>
</body>
</html>
