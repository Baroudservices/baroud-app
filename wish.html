<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Whish Money</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root{
      --bg1:#060b16; --bg2:#0a1330;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.65);
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --r:26px; --r2:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 30% 10%, rgba(64,120,255,.22), transparent 60%),
        radial-gradient(800px 500px at 80% 40%, rgba(0,255,209,.12), transparent 55%),
        linear-gradient(160deg,var(--bg1),var(--bg2));
      padding:18px;
    }

    .topbar{
      max-width:460px;
      margin:6px auto 10px;
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;
    }
    .back{
      cursor:pointer;
      display:flex;align-items:center;gap:10px;
      user-select:none;
      opacity:.95;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
    }

    .wrap{max-width:460px;margin:0 auto;}
    .wishLogo{
      display:flex;justify-content:center;
      margin:10px 0 6px;
    }
    .wishLogo img{
      height:60px;
      background:none;
      box-shadow:none;
    }

    .title{
      font-size:42px;
      font-weight:900;
      margin:14px 0 18px;
      text-align:center;
      letter-spacing:.2px;
    }

    .glass{
      border:1px solid var(--stroke);
      background:var(--card);
      backdrop-filter:blur(14px);
      border-radius:var(--r);
      padding:18px;
      box-shadow:var(--shadow);
    }
    .box{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      padding:14px;
      margin-bottom:14px;
    }

    .id{
      width:100%;
      text-align:center;
      padding:14px;
      border-radius:18px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      font-weight:900;
      letter-spacing:.4px;
      margin:10px 0 4px;
    }

    input{
      width:100%;
      padding:16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      margin-top:10px;
      font-size:16px;
    }

    .btn{
      width:100%;
      border:none;
      padding:18px;
      border-radius:18px;
      margin-top:14px;
      cursor:pointer;
      color:white;
      font-weight:900;
      font-size:16px;
      background:linear-gradient(90deg, rgba(14,165,233,.95), rgba(37,99,235,.95));
      box-shadow:0 18px 45px rgba(37,99,235,.25);
      position:relative;
      z-index:2;
    }
    .btn:active{transform:scale(.99)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .foot{
      text-align:center;
      color:var(--muted);
      margin-top:16px;
      opacity:.8;
    }

    /* overlay */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:9999;
      padding:18px;

      /* مهم: لما تكون مخفية ما تاكل الكليكات */
      pointer-events:none;
    }
    .overlay.show{
      display:flex;
      pointer-events:auto;
    }
    .modal{
      max-width:420px; width:100%;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,23,42,.92);
      backdrop-filter:blur(12px);
      padding:16px;
      box-shadow:0 30px 80px rgba(0,0,0,.55);
    }
    .modal h3{margin:0 0 8px;font-size:18px}
    .modal p{margin:0;color:rgba(234,242,255,.8);line-height:1.4}
    .modal .ok{
      margin-top:14px;
      width:100%;
      padding:12px;
      border-radius:14px;
      border:0;
      font-weight:900;
      cursor:pointer;
      background:rgba(255,255,255,.10);
      color:#fff;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="back" id="btnBack">← رجوع</div>
  </div>

  <div class="wrap">
    <div class="wishLogo">
      <img src="assets/wish.png" alt="Wish Money">
    </div>

    <div class="title">Whish Money $</div>

    <div class="glass">
      <div class="box">
        <div style="color:var(--muted);font-weight:700;">
          Please send the amount to this number ID:
        </div>
        <div class="id">+961 70385398</div>

        <div style="margin-top:10px;color:var(--muted);font-weight:700;">
          The minimum deposit is <b style="color:var(--text)">10$</b><br/>
          It takes between <b style="color:var(--text)">1 & 15</b> minutes
        </div>
      </div>

      <input id="amount" type="number" placeholder="Enter amount $" />
      <input id="receipt" type="file" accept="image/*" />

      <!-- مهم: type="button" -->
      <button id="btnReq" type="button" class="btn">REQUEST</button>

      <div class="foot">© 2024 Baroud Services</div>
    </div>
  </div>

  <!-- overlay -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="ovTitle">Done</h3>
      <p id="ovMsg">...</p>
      <button class="ok" id="ovOk">OK</button>
    </div>
  </div>

  <script>
  const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
  const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";

  let supabase = null;

  function goBack(){
    window.location.replace("add-credit.html?v=" + Date.now());
  }

  function showOverlay(title, msg){
    const t = document.getElementById("ovTitle");
    const m = document.getElementById("ovMsg");
    const o = document.getElementById("overlay");
    if (!t || !m || !o) return alert(title + "\n" + msg);
    t.textContent = title;
    m.textContent = msg;
    o.classList.add("show");
  }

  function hideOverlay(){
    const o = document.getElementById("overlay");
    if (!o) return;
    o.classList.remove("show");
  }

  async function requestNow(){
    const btn = document.getElementById("btnReq");
    const amountEl = document.getElementById("amount");
    const fileEl   = document.getElementById("receipt");

    if(!btn || !amountEl || !fileEl){
      showOverlay("Error ❌", "Missing HTML elements (btnReq/amount/receipt).");
      return;
    }

    const amount = Number(amountEl.value);
    const file = fileEl.files && fileEl.files[0];

    if(!amount || amount < 10){
      showOverlay("Error ❌", "Minimum deposit is 10$");
      return;
    }
    if(!file){
      showOverlay("Error ❌", "Please upload receipt image");
      return;
    }

    if(!supabase){
      showOverlay("Error ❌", "Supabase not loaded. Refresh the page.");
      return;
    }

    btn.disabled = true;
    btn.textContent = "SENDING...";

    try{
      // 1) session
      const { data: sessionData, error: sessionErr } = await supabase.auth.getSession();
      if(sessionErr) throw sessionErr;

      const user = sessionData?.session?.user;
      if(!user){
        window.location.replace("login.html?v=" + Date.now());
        return;
      }

      // 2) upload receipt
      const extRaw = (file.name.split(".").pop() || "jpg").toLowerCase();
      const safeExt = ["jpg","jpeg","png","webp"].includes(extRaw) ? extRaw : "jpg";
      const fileName = `${user.id}/${Date.now()}.${safeExt}`;

      const { error: uploadErr } = await supabase
        .storage
        .from("receipts")
        .upload(fileName, file, { upsert: false });

      if(uploadErr) throw uploadErr;

      // 3) insert deposits
      const { error: insertErr } = await supabase
        .from("deposits")
        .insert([{
          user_id: user.id,
          method: "Whish Money",
          amount: amount,
          receipt_path: fileName,
          status: "pending"
        }]);

      if(insertErr) throw insertErr;

      showOverlay("Request sent ✅", "Your deposit request is pending. We will review it soon.");
      amountEl.value = "";
      fileEl.value = "";

    }catch(e){
      console.error(e);
      showOverlay("Failed ❌", e?.message || "Something went wrong");
    }finally{
      btn.disabled = false;
      btn.textContent = "REQUEST";
    }
  }

  function init(){
    // ✅ تهيئة Supabase الصحيحة للـ UMD v2
    // المكتبة رح تكون window.supabaseJs
    if(window.supabaseJs && window.supabaseJs.createClient){
      supabase = window.supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);
    }else{
      showOverlay("Error ❌", "Supabase library failed to load. Check the CDN link.");
      return;
    }

    // ربط الأزرار (مرة وحدة فقط)
    const btnBack = document.getElementById("btnBack");
    const btnReq  = document.getElementById("btnReq");
    const ovOk    = document.getElementById("ovOk");

    if(btnBack) btnBack.addEventListener("click", goBack);
    if(btnReq)  btnReq.addEventListener("click", requestNow);
    if(ovOk)    ovOk.addEventListener("click", hideOverlay);
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
