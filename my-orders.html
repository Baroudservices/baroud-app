<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Orders</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{ margin:0; font-family:system-ui,Arial; background:linear-gradient(180deg,#0b1424,#050a14); color:#fff; min-height:100vh; padding:16px; }
    .wrap{max-width:820px;margin:auto}
    .top{ display:flex;align-items:center;gap:10px; margin-bottom:14px; }
    .back{ padding:10px 14px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); cursor:pointer; text-decoration:none; color:#fff; }
    h2{margin:0;font-size:22px}
    .card{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:14px; margin-bottom:12px; }
    .row{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap; }
    .name{font-weight:900; font-size:18px}
    .small{opacity:.68;font-size:12px; line-height:1.35}
    .price{font-weight:900;color:#38bdf8; font-size:18px}
    .badge{
      display:inline-block; padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
      margin-top:8px;
    }
    .badge.pending{ color:#fbbf24; }
    .badge.rejected{ color:#ff4d4d; }
    .badge.done, .badge.paid{ color:#22c55e; }

    .details{
      margin-top:12px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
    }
    .kv{ display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06); }
    .kv:last-child{ border-bottom:0; }
    .k{ opacity:.7; font-size:12px; font-weight:800; }
    .v{ font-size:12px; font-weight:900; text-align:right; max-width:65%; word-break:break-word; }

    .empty{ opacity:.75; text-align:center; margin-top:40px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <a href="services.html" class="back">←</a>
    <h2>My Orders</h2>
  </div>

  <div id="list"></div>
  <div id="empty" class="empty" style="display:none">No orders</div>
</div>

<script>
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function esc(s){ return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function toArr(x){ return Array.isArray(x) ? x : []; }

function statusClass(s){
  const v = String(s||"pending").toLowerCase();
  if(v.includes("reject")) return "rejected";
  if(v.includes("done")) return "done";
  if(v.includes("paid")) return "paid";
  return "pending";
}

function pickDetails(o){
  // عرض أهم الحقول إذا موجودة (بدون ما نعلق على أسماء الأعمدة)
  const candidates = [
    ["phone_number","Phone"],
    ["transfer_number","Phone"],
    ["number","Phone"],
    ["player_id","Player ID"],
    ["player_name","Player Name"],
    ["account_email","Email"],
    ["account_password","Password"],
    ["duration","Duration"],
    ["note","Note"],
    ["plan_label","Plan"],
    ["title","Title"],
    ["product_title","Product"],
    ["alfa_amount","Amount"],
    ["mtc_amount","Amount"],
  ];

  const out = [];
  candidates.forEach(([key,label])=>{
    if(o && o[key] !== null && o[key] !== undefined && String(o[key]).trim() !== ""){
      out.push([label, String(o[key])]);
    }
  });

  // إذا ما لقيت شي من فوق، جرّب تعرض أي مفاتيح إضافية غير الأساسية
  if(out.length === 0 && o){
    const skip = new Set(["id","user_id","product_id","price","status","delivery_status","admin_reply","created_at","admin_reply_at","refunded_at","refunded_amount","refunded_txn"]);
    Object.keys(o).forEach(k=>{
      if(skip.has(k)) return;
      const val = o[k];
      if(val === null || val === undefined) return;
      const s = String(val).trim();
      if(!s) return;
      out.push([k, s]);
    });
  }

  return out;
}

async function loadOrders(){
  const listEl = document.getElementById("list");
  const emptyEl = document.getElementById("empty");
  listEl.innerHTML = "";
  emptyEl.style.display = "none";

  const { data: { session } } = await sb.auth.getSession();
  if(!session) { location.replace("login.html"); return; }

  // 1) fetch my orders (كل الأعمدة)
  const { data: orders, error: e1 } = await sb
    .from("orders")
    .select("*")
    .eq("user_id", session.user.id)
    .order("created_at", { ascending:false });

  if(e1){
    listEl.innerHTML = `<div class="empty">Error: ${esc(e1.message)}</div>`;
    return;
  }

  if(!orders || orders.length === 0){
    emptyEl.style.display = "block";
    return;
  }

  // 2) map product titles (لو موجود products)
  const ids = [...new Set(toArr(orders).map(o => o.product_id).filter(Boolean))];
  let titleById = {};
  if(ids.length){
    const { data: prods } = await sb.from("products").select("id,title").in("id", ids);
    toArr(prods).forEach(p => titleById[p.id] = p.title);
  }

  listEl.innerHTML = orders.map(o => {
    const title = titleById[o.product_id] || o.title || "Order";
    const sc = statusClass(o.delivery_status || o.status);
    const paidClass = statusClass(o.status);
    const dt = o.created_at ? new Date(o.created_at).toLocaleString() : "";
    const details = pickDetails(o);

    const detailsHtml = details.length ? `
      <div class="details">
        ${details.map(([k,v])=>`
          <div class="kv">
            <div class="k">${esc(k)}</div>
            <div class="v">${esc(v)}</div>
          </div>
        `).join("")}
        <div class="kv">
          <div class="k">Admin Reply</div>
          <div class="v">${esc(o.admin_reply || "No details yet")}</div>
        </div>
      </div>
    ` : `
      <div class="details">
        <div class="kv">
          <div class="k">Admin Reply</div>
          <div class="v">${esc(o.admin_reply || "No details yet")}</div>
        </div>
      </div>
    `;

    return `
      <div class="card">
        <div class="row">
          <div>
            <div class="name">${esc(title)}</div>
            <div class="small">${esc(dt)}</div>
            <div class="small">Order #${esc(o.id)}</div>
            <div class="badge ${paidClass}">Payment: ${esc((o.status||"pending").toUpperCase())}</div>
            <div class="badge ${sc}" style="margin-left:6px">Delivery: ${esc((o.delivery_status||"pending").toUpperCase())}</div>
          </div>
          <div class="price">$${Number(o.price || 0).toFixed(2)}</div>
        </div>

        ${detailsHtml}
      </div>
    `;
  }).join("");
}

loadOrders();
</script>
</body>
</html>
