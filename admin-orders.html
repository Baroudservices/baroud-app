<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Orders</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{ margin:0; font-family:system-ui,Arial; background:linear-gradient(180deg,#0b1424,#050a14); color:#fff; min-height:100vh; padding:16px; }
  .wrap{max-width:880px;margin:auto}
  .top{ display:flex;align-items:center;gap:10px; margin-bottom:14px; }
  .back{ padding:10px 14px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); cursor:pointer; text-decoration: none; color: white; }
  h2{margin:0;font-size:22px}
  .card{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:14px; margin-bottom:12px; }
  .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .name{font-weight:900}
  .small{opacity:.65;font-size:12px}
  .price{font-weight:900;color:#38bdf8}
  select, textarea, input{
    background:rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.12);
    color:#fff;
    border-radius:12px;
    padding:10px;
    outline:none;
  }
  textarea{ width:100%; min-height:90px; resize:vertical; }
  .btn{
    border:0; cursor:pointer; padding:12px 14px; border-radius:14px;
    font-weight:950; color:#fff; background:linear-gradient(90deg,#0aa0ff,#2a74ff);
  }
  .btn2{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
  }
  .empty{ opacity:.7; text-align:center; margin-top:40px; }
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <a href="admin.html" class="back">←</a>
    <h2>Admin Orders</h2>
  </div>

  <div class="row" style="margin-bottom:12px">
    <input id="q" placeholder="Search by order id / user id" style="flex:1; min-width:220px" />
    <button class="btn btn2" onclick="loadOrders()">Refresh</button>
  </div>

  <div id="list"></div>
  <div id="empty" class="empty" style="display:none">No orders</div>
</div>

<script>
const SUPABASE_URL = "https://pqrwitolonhfbfwtsnde.supabase.co";
const SUPABASE_KEY = "sb_publishable_l5PtPu6xVyWq2pD6jzEYRw_CYEQ9-f_";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function esc(s){ return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function toArr(x){ return Array.isArray(x) ? x : []; }

async function loadOrders(){
  const listEl = document.getElementById("list");
  const emptyEl = document.getElementById("empty");
  listEl.innerHTML = "";
  emptyEl.style.display = "none";

  const { data: { session } } = await sb.auth.getSession();
  if(!session) { location.replace("login.html"); return; }

  // 1) fetch orders
  const { data: orders, error: e1 } = await sb
    .from("orders")
    .select("id,user_id,product_id,price,status,delivery_status,admin_reply,created_at")
    .order("created_at", { ascending:false });

  if(e1){
    listEl.innerHTML = `<div class="empty">Error: ${esc(e1.message)}</div>`;
    return;
  }

  if(!orders || orders.length === 0){
    emptyEl.style.display = "block";
    return;
  }

  // 2) map product titles
  const ids = [...new Set(toArr(orders).map(o => o.product_id).filter(Boolean))];
  let titleById = {};
  if(ids.length){
    const { data: prods } = await sb.from("products").select("id,title").in("id", ids);
    toArr(prods).forEach(p => titleById[p.id] = p.title);
  }

  // 3) simple search filter
  const term = (document.getElementById("q").value || "").trim().toLowerCase();
  const filtered = term
    ? orders.filter(o => String(o.id).toLowerCase().includes(term) || String(o.user_id).toLowerCase().includes(term))
    : orders;

  if(!filtered.length){
    emptyEl.style.display = "block";
    return;
  }

  listEl.innerHTML = filtered.map(o => {
    const title = titleById[o.product_id] || "Product";
    const status = (o.status || "pending").toLowerCase();
    const delivery = (o.delivery_status || "pending").toLowerCase();
    const reply = o.admin_reply || "";

    return `
      <div class="card" id="card_${esc(o.id)}">
        <div class="row">
          <div>
            <div class="name">${esc(title)}</div>
            <div class="small">Order #${esc(o.id)} • ${new Date(o.created_at).toLocaleString()}</div>
            <div class="small">User: ${esc(o.user_id)}</div>
          </div>
          <div class="price">$${Number(o.price || 0).toFixed(2)}</div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <div class="small">Payment Status</div>
            <select id="status_${esc(o.id)}">
              <option value="pending" ${status==="pending"?"selected":""}>pending</option>
              <option value="paid" ${status==="paid"?"selected":""}>paid</option>
              <option value="cancelled" ${status==="cancelled"?"selected":""}>cancelled</option>
            </select>
          </div>

          <div>
            <div class="small">Delivery Status</div>
            <select id="delivery_${esc(o.id)}">
              <option value="pending" ${delivery==="pending"?"selected":""}>pending</option>
              <option value="done" ${delivery==="done"?"selected":""}>done</option>
              <option value="rejected" ${delivery==="rejected"?"selected":""}>rejected</option>
            </select>
          </div>

          <div style="flex:1; min-width:240px">
            <div class="small">Admin Reply</div>
            <textarea id="reply_${esc(o.id)}" placeholder="Write details / delivery info...">${esc(reply)}</textarea>
          </div>

          <div style="min-width:180px">
            <button class="btn" onclick="saveOrder(${esc(o.id)})">Save</button>
            <div id="msg_${esc(o.id)}" class="small" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

async function saveOrder(orderId){
  const msg = document.getElementById(`msg_${orderId}`);
  msg.textContent = "Saving...";

  const status = document.getElementById(`status_${orderId}`).value;
  const delivery_status = document.getElementById(`delivery_${orderId}`).value;
  const admin_reply = document.getElementById(`reply_${orderId}`).value;

  const { error } = await sb
    .from("orders")
    .update({ status, delivery_status, admin_reply })
    .eq("id", orderId);

  if(error){
    msg.textContent = `Error: ${error.message}`;
    return;
  }

  msg.textContent = "Saved ✅";
}

loadOrders();
</script>
</body>
</html>
